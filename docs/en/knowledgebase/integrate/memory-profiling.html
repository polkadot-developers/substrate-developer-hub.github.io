<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Memory Profiling · Substrate Developer Hub</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Memory profiling enables you to understand the memory allocation and behavior of your blockchain"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Memory Profiling · Substrate Developer Hub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://substrate-developer-hub.github.io//"/><meta property="og:description" content="Memory profiling enables you to understand the memory allocation and behavior of your blockchain"/><meta property="og:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/load.js"></script><script type="text/javascript" src="/js/redirect-next.js"></script><script type="text/javascript" src="/js/config.js" defer=""></script><script type="text/javascript" src="/js/klaro.min.js" defer=""></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/en"><img class="logo" src="/img/Substrate-logo.svg" alt="Substrate Developer Hub"/><h2 class="headerTitleWithLogo">Substrate Developer Hub</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/en/tutorials" target="_self">Tutorials</a></li><li class="siteNavGroupActive"><a href="/docs/en/" target="_self">Knowledge Base</a></li><li class=""><a href="https://substrate.dev/recipes/" target="_self">Recipes</a></li><li class=""><a href="https://substrate.dev/rustdocs/" target="_self">API Reference</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg" alt="Languages icon"/>English</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/zh-CN/knowledgebase/integrate/memory-profiling">简体中文</a></li><li><a href="https://crowdin.com/project/substrate-developer-hub" target="_blank" rel="noreferrer noopener">Help Translate</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Integrate</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Getting Started<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/getting-started/architecture">Architecture</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/getting-started/">Installation</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/getting-started/windows-users">Getting Started on Windows</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/getting-started/glossary">Glossary</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Substrate Key Concepts<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/">Runtime</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/learn-substrate/extrinsics">Extrinsics</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/learn-substrate/account-abstractions">Account Abstractions</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/learn-substrate/tx-pool">Transaction Pool</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/learn-substrate/session-keys">Session Keys</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/learn-substrate/weight">Transaction Weight</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/learn-substrate/off-chain-features">Off-Chain Features</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Runtime Development<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/pallets">Pallets</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/frame">FRAME</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/macros">Macros</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/metadata">Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/storage">Storage</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/origin">Origin</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/execution">Execution</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/events">Events</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/errors">Errors</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/fees">Transaction Fees</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/debugging">Debugging</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/tests">Tests</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/benchmarking">Benchmarking</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/randomness">On-Chain Randomness</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/runtime/upgrades">Upgrades</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Smart Contracts<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/smart-contracts/">Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/smart-contracts/ink-fundamentals">ink! Concepts</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/smart-contracts/ink-development">ink! Development</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/smart-contracts/contracts-pallet">Contracts Pallet</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/smart-contracts/evm-pallet">EVM Pallet</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/smart-contracts/faq">ink! F.A.Q.</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Integrate<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/integrate/polkadot-js">Polkadot-JS</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/integrate/libraries">Client Libraries</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/integrate/chain-spec">Chain Specification</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/integrate/subkey">The Subkey Tool</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/en/knowledgebase/integrate/memory-profiling">Memory Profiling</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Advanced<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/account-info">Account Information</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/codec">SCALE Codec</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/consensus">Consensus</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/block-import">The Block Import Pipeline</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/executor">Runtime Executor</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/cryptography">Cryptography</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/storage">Storage</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/ss58-address-format">SS58 Address Format</a></li><li class="navListItem"><a class="navItem" href="/docs/en/knowledgebase/advanced/no-hash-collections">Why are there no Hash collections in sp_std?</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Contribute<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/en/contribute/help-translate">Help Translate</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/substrate-developer-hub/substrate-developer-hub.github.io/edit/source/docs/knowledgebase/integrate/memory-profiling.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 id="__docusaurus" class="postHeaderTitle">Memory Profiling</h1></header><article><div><span><p>Memory profiling enables you to understand the memory allocation and behavior of your blockchain
applications over time in Substrate-based clients. It identifies method calls in the context of how
memory was allocated, combining this information with the number of allocated objects. In addition,
profiling can be used to analyze memory leaks, identify where memory consumption is happening,
define temporary allocations, and investigate excessive memory fragmentation within applications.</p>
<p>The profiler we recommend is <a href="https://github.com/koute/memory-profiler">koute's memory profiler</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="installation"></a><a href="#installation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installation</h2>
<h3><a class="anchor" aria-hidden="true" id="from-a-binary-release"></a><a href="#from-a-binary-release" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>...from a binary release</h3>
<p>You can download a precompiled binary release of the profiler from <a href="https://github.com/koute/memory-profiler/releases">here</a>.
The last version we've tested is 0.6.1, but any newer one will also most likely work.</p>
<p>Here's how you can download and unpack it from the command-line:</p>
<pre><code class="hljs css language-bash">$ curl -L https://github.com/koute/memory-profiler/releases/download/0.6.1/memory-profiler-x86_64-unknown-linux-gnu.tgz -o memory-profiler-x86_64-unknown-linux-gnu.tgz
$ tar -xf memory-profiler-x86_64-unknown-linux-gnu.tgz
</code></pre>
<p>This will result in three files being unpacked. We're only interested in two of them:</p>
<ul>
<li><code>libmemory_profiler.so</code> - this is the memory profiler itself that we will hook into Substrate</li>
<li><code>memory-profiler-cli</code> - this is the program we will later use to analyze the profiling data</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="from-source"></a><a href="#from-source" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>...from source</h3>
<p>You can also <a href="https://github.com/koute/memory-profiler#building">compile the profiler from source</a> yourself.</p>
<p>First you need to make sure to have the following installed:</p>
<ul>
<li>GCC toolchain</li>
<li>Rust nightly (we've tested version <code>nightly-2021-06-08</code>)</li>
<li><a href="https://yarnpkg.com">Yarn</a> package manager (for building the GUI)</li>
</ul>
<p>Then you should be able to build the profiler like this:</p>
<pre><code class="hljs css language-bash">$ git <span class="hljs-built_in">clone</span> https://github.com/koute/memory-profiler
$ <span class="hljs-built_in">cd</span> memory-profiler
$ cargo build --release -p memory-profiler
$ cargo build --release -p memory-profiler-cli
</code></pre>
<p>You'll find the binaries we need in <code>target/release/libmemory_profiler.so</code> and <code>target/release/memory-profiler-cli</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="hooking-up-the-profiler-to-substrate"></a><a href="#hooking-up-the-profiler-to-substrate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hooking up the profiler to Substrate</h2>
<p>This part heavily depends on how exactly you're launching Substrate.</p>
<h3><a class="anchor" aria-hidden="true" id="hooking-to-a-manually-launched-substrate"></a><a href="#hooking-to-a-manually-launched-substrate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hooking to a manually launched Substrate</h3>
<p>If you're manually launching Substrate from the command-line then hooking the profiler up to it
boils down to just setting up a few extra environment variables and then launching it normally as
you'd usually do.</p>
<p>First, we want to enable logging, tell the profiler where it's supposed to output its logs, where it
should gather its profiling data, and optionally tell it to cull temporary allocations:</p>
<pre><code class="hljs css language-bash">$ <span class="hljs-built_in">export</span> MEMORY_PROFILER_LOG=info
$ <span class="hljs-built_in">export</span> MEMORY_PROFILER_LOGFILE=profiling_%e_%t.log
$ <span class="hljs-built_in">export</span> MEMORY_PROFILER_OUTPUT=profiling_%e_%t.dat

<span class="hljs-comment"># Optional, depending on what exact aspect you'd like to profile</span>
<span class="hljs-comment"># and how long you're going to be profiling.</span>
$ <span class="hljs-built_in">export</span> MEMORY_PROFILER_CULL_TEMPORARY_ALLOCATIONS=1
</code></pre>
<p>Then we can launch Substrate with the profiler attached:</p>
<pre><code class="hljs css language-bash">$ LD_PRELOAD=/path/to/libmemory_profiler.so ./target/release/substrate
</code></pre>
<p>Setting the <code>LD_PRELOAD</code> environment variable will instruct Linux's dynamic linker to inject the
memory profiler into Substrate just before it's launched, which allows the profiler to hook into the
system's memory allocation routines and track every memory allocation that Substrate's doing.</p>
<h3><a class="anchor" aria-hidden="true" id="hooking-to-substrate-launched-through-systemd"></a><a href="#hooking-to-substrate-launched-through-systemd" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hooking to Substrate launched through <code>systemd</code></h3>
<p>If you're running a Substrate-based node remotely you're probably using <code>systemd</code> to manage it.
Here's how you could go about setting up profiling in such a situation.</p>
<p>We assume you've already either downloaded a precompiled binary of the profiler or compiled it from
source, and you have it in your current directory.</p>
<p>First, we want to copy the memory profiler to a globally accessible location and set up a place
where it can write its logs and gather the profiling data.</p>
<pre><code class="hljs css language-bash">$ sudo mkdir -p /opt/memory-profiler/bin
$ sudo cp libmemory_profiler.so /opt/memory-profiler/bin/
$ sudo mkdir /opt/memory-profiler/logs
$ sudo chmod 0777 /opt/memory-profiler/logs
</code></pre>
<p>Then we want to set up a file with all of the environment variables to configure the profiler itself:</p>
<pre><code class="hljs css language-bash">$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"MEMORY_PROFILER_OUTPUT=/opt/memory-profiler/logs/profiling_%e_%t_%p.dat"</span> | sudo tee /opt/memory-profiler/env
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"MEMORY_PROFILER_LOGFILE=/opt/memory-profiler/logs/profiling_%e_%t_%p.txt"</span> | sudo tee -a /opt/memory-profiler/env
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"MEMORY_PROFILER_LOG=info"</span> | sudo tee -a /opt/memory-profiler/env
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"MEMORY_PROFILER_CULL_TEMPORARY_ALLOCATIONS=1"</span> | sudo tee -a /opt/memory-profiler/env
$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"LD_PRELOAD=/opt/memory-profiler/bin/libmemory_profiler.so"</span> | sudo tee -a /opt/memory-profiler/env
</code></pre>
<p>Now you want to open your <code>systemd</code> unit file for your node and add the following in the <code>[Service]</code> section:</p>
<pre><code class="hljs"><span class="token punctuation">[</span><span class="token class-name">Service</span><span class="token punctuation">]</span>
<span class="token class-name">EnvironmentFile</span><span class="token operator">=</span><span class="token operator">/</span>opt<span class="token operator">/</span>memory<span class="token operator">-</span>profiler<span class="token operator">/</span>env
</code></pre>
<p>Do not add another <code>[Service]</code> section if one already exists; just add the <code>EnvironmentFile</code> key to it.
If you already have one <code>EnvironmentFile</code> key do not replace it; just add a second one, <code>systemd</code> will apply both.</p>
<p>Now you can reload your <code>systemd</code> daemon:</p>
<pre><code class="hljs css language-bash">$ sudo systemctl daemon-reload
</code></pre>
<p>And then restart your service to start the profiling:</p>
<pre><code class="hljs css language-bash">$ sudo systemctl restart kusama
</code></pre>
<p>The profiling data will be gathered at <code>/opt/memory-profiler/logs</code>. If you want to disable the
memory profiler just delete the <code>EnvironmentFile</code> key you've added to your unit file, and restart
the service again.</p>
<h3><a class="anchor" aria-hidden="true" id="configuring-the-profiler"></a><a href="#configuring-the-profiler" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configuring the profiler</h3>
<p>There are also <a href="https://github.com/koute/memory-profiler#environment-variables-used-by-libmemory_profilerso">other environment variables you can set to configure the profiler</a>,
although besides the ones we've already shown changing them shouldn't be necessary in normal circumstances.</p>
<p>One configuration knob that warrants extra consideration is <code>MEMORY_PROFILER_CULL_TEMPORARY_ALLOCATIONS</code>,
which controls whenever the profiler will gather short lived allocations.</p>
<p>By default the profiler will gather <strong>every</strong> allocation that's made by the profiled application.
That is a <em>lot</em> of data, and can be on the order of <em>megabytes</em> per second. This is great if you
want to only profile for a short period of time, or if you specifically care about diagnosing
temporary allocations, but it becomes problematic when you want to leave the profiler running for
longer.</p>
<p>This is where the <code>MEMORY_PROFILER_CULL_TEMPORARY_ALLOCATIONS</code> option comes in. When you turn it on
by setting it to <code>1</code> the profiler will omit all of the really short lived allocations and not write
them out to disk. This significantly cuts down the amount of data that's generated, usually to the
range of <em>kilobytes</em> per second, which makes it possible to leave the profiling running for days at
a time.</p>
<h2><a class="anchor" aria-hidden="true" id="analysis"></a><a href="#analysis" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Analysis</h2>
<p>Now that you've gathered the profiling data you can now analyze it.</p>
<p>Assuming you have both the <code>memory-profiler-cli</code> and the <code>.dat</code> file you've gathered
in the same directory you can load the GUI for it:</p>
<pre><code class="hljs css language-bash">$ ./memory-profiler-cli server *.dat
</code></pre>
<p>This might take a while, depending or your exact hardware and on the amount of data you're trying to load.
Eventually you should see something like this being printed out:</p>
<pre><code class="hljs"><span class="token punctuation">[</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span>06T08<span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span>20Z <span class="token constant">INFO</span>  <span class="token namespace">cli_core<span class="token punctuation">::</span></span>loader<span class="token punctuation">]</span> <span class="token class-name">Loaded</span> data <span class="token keyword">in</span> 315s <span class="token number">820</span>
<span class="token punctuation">[</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span>06T08<span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span>20Z <span class="token constant">INFO</span>  <span class="token namespace">actix_server<span class="token punctuation">::</span></span>builder<span class="token punctuation">]</span> <span class="token class-name">Starting</span> <span class="token number">8</span> workers
<span class="token punctuation">[</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">05</span><span class="token operator">-</span>06T08<span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span>20Z <span class="token constant">INFO</span>  <span class="token namespace">actix_server<span class="token punctuation">::</span></span>builder<span class="token punctuation">]</span> <span class="token class-name">Starting</span> server on <span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">8080</span>
</code></pre>
<p>Now you can open your web browser and access the GUI at <code>http://localhost:8080/</code>.</p>
<p><img src="../../../assets/memory-graph.png" alt="Graphs from the web UI"></p>
<p>There's also <a href="https://github.com/koute/memory-profiler#rest-api-exposed-by-memory-profiler-cli-server">a REST API</a>
that you can access you'd like to export the data into another format or inspect it programmatically.</p>
<h2><a class="anchor" aria-hidden="true" id="miscellaneous-tips"></a><a href="#miscellaneous-tips" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Miscellaneous tips</h2>
<ul>
<li><p>It's a good idea to always check the logs generated by the profiler and see whenever there are any
<code>WRN</code> or <code>ERR</code> logs present.</p></li>
<li><p>You might see the the following error or warning in the profiler's logs depending on which Linux
distribution you're running:</p>
<pre><code class="hljs"><span class="token class-name">The</span> perf_event_open syscall failed <span class="token keyword">for</span> <span class="token constant">PID</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token class-name">Operation</span> not <span class="token function">permitted</span> <span class="token punctuation">(</span>os error <span class="token number">1</span><span class="token punctuation">)</span>`
</code></pre>
<p>This is generally harmless; at most this should only result in higher CPU usage when profiling.
You can avoid it by doing something like this:</p>
<pre><code class="hljs css language-bash">$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"-1"</span> | sudo tee /proc/sys/kernel/perf_event_paranoid
</code></pre>
<p>Although please note that this might have some security implications. Take a look at
<code>man perf_event_open</code> for more details.</p></li>
<li><p>During analysis the whole data file has to be loaded into memory. If you don't have enough RAM
and you'll try to load up a big file the analyzer might run out of memory and crash.</p></li>
</ul>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 6/10/2021 by Koute</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/en/knowledgebase/integrate/subkey"><span class="arrow-prev">← </span><span>The Subkey Tool</span></a><a class="docs-next button" href="/docs/en/knowledgebase/advanced/account-info"><span>Account Information</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#installation">Installation</a><ul class="toc-headings"><li><a href="#from-a-binary-release">...from a binary release</a></li><li><a href="#from-source">...from source</a></li></ul></li><li><a href="#hooking-up-the-profiler-to-substrate">Hooking up the profiler to Substrate</a><ul class="toc-headings"><li><a href="#hooking-to-a-manually-launched-substrate">Hooking to a manually launched Substrate</a></li><li><a href="#hooking-to-substrate-launched-through-systemd">Hooking to Substrate launched through <code>systemd</code></a></li><li><a href="#configuring-the-profiler">Configuring the profiler</a></li></ul></li><li><a href="#analysis">Analysis</a></li><li><a href="#miscellaneous-tips">Miscellaneous tips</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/Substrate-logo.svg" alt="Substrate Developer Hub" width="66" height="58"/></a><div><h5>Developer Hub</h5><a href="/en/tutorials">Tutorials</a><a href="/docs/en/">Knowledge Base</a><a href="https://substrate.dev/recipes/">Recipes</a><a href="https://substrate.dev/rustdocs">API Reference</a></div><div><h5>Community</h5><a href="/en/community">Community Home</a><a href="/en/newsletter">Newsletter</a><a href="https://app.element.io/#/room/!HzySYSaIhtyWrwiwEV:matrix.org">Substrate Technical Chat</a><a href="/en/seminar">Substrate Seminar</a><a href="http://stackoverflow.com/questions/tagged/substrate" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://twitter.com/substrate_io" target="_blank" rel="noreferrer noopener">Twitter</a><a href="https://www.meetup.com/parity/" target="_blank" rel="noreferrer noopener">Events</a></div><div><h5>More</h5><a href="https://www.substrate.io/builders-program/">Substrate Builders Program</a><a href="https://www.parity.io/blog/">Blog</a><a href="https://github.com/paritytech/substrate">Substrate GitHub</a><a href="https://github.com/substrate-developer-hub/">Developer Hub GitHub</a><a href="https://www.parity.io/privacy/">Privacy Policy</a><a href="/terms">Terms of Use</a><a href="#" id="cookie-settings">Cookie Settings<script>
                var cookieSettings = document.getElementById('cookie-settings');
                cookieSettings.onclick = function() {
                  return klaro.show();
                };
              </script></a></div></section><section class="copyright">Copyright © 2021 Parity Technologies</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '5cd09916f4ba4c283b2d45ee7386fc34',
                indexName: 'substrate',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["language:en"]}
              });
            </script></body></html>