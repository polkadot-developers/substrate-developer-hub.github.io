<!DOCTYPE html><html lang="ru"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Building the Substrate TCR runtime · Substrate Developer Hub</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="This is Part 1 of the guide [Building a Token Curated Registry DAppChain on Substrate](/docs/ru/tutorials/tcr/). This part covers the implementation of the Substrate runtime pallets needed for the Token Curated Registry runtime."/><meta name="docsearch:version" content="pre-2.0"/><meta name="docsearch:language" content="ru"/><meta property="og:title" content="Building the Substrate TCR runtime · Substrate Developer Hub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://substrate-developer-hub.github.io//"/><meta property="og:description" content="This is Part 1 of the guide [Building a Token Curated Registry DAppChain on Substrate](/docs/ru/tutorials/tcr/). This part covers the implementation of the Substrate runtime pallets needed for the Token Curated Registry runtime."/><meta property="og:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/load.js"></script><script type="text/javascript" src="/js/ui.js" defer=""></script><script type="text/javascript" src="/js/config.js" defer=""></script><script type="text/javascript" src="/js/klaro.min.js" defer=""></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/ru"><img class="logo" src="/img/Substrate-logo.svg" alt="Substrate Developer Hub"/><h2 class="headerTitleWithLogo">Substrate Developer Hub</h2></a><a href="/ru/versions"><h3>pre-2.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/ru/" target="_self">Docs</a></li><li class=""><a href="/recipes" target="_self">Recipes</a></li><li class=""><a href="/ru/tutorials" target="_self">Tutorials</a></li><li class=""><a href="/ru/community" target="_self">Community</a></li><li class=""><a href="https://github.com/paritytech/substrate" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg" alt="Languages icon"/>Русский</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/en/tutorials/tcr/building-the-substrate-tcr-runtime">English</a></li><li><a href="/docs/zh-CN/tutorials/tcr/building-the-substrate-tcr-runtime">中文</a></li><li><a href="https://crowdin.com/project/substrate-developer-hub" target="_blank" rel="noreferrer noopener">Help Translate</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://crowdin.com/project/substrate-developer-hub/ru" target="_blank" rel="noreferrer noopener">Translate</a><h1 id="__docusaurus" class="postHeaderTitle">Building the Substrate TCR runtime</h1></header><article><div><span><p>This is Part 1 of the guide <a href="/docs/ru/tutorials/tcr/">Building a Token Curated Registry DAppChain on Substrate</a>. This part covers the implementation of the Substrate runtime pallets needed for the Token Curated Registry runtime.</p>
<p>The code for the sample TCR runtime is available in <a href="https://github.com/substrate-developer-hub/substrate-tcr/">this GitHub repository</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="step-1-setup-and-prerequisites"></a><a href="#step-1-setup-and-prerequisites" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 1: Setup and prerequisites</h2>
<p>In this guide, we will directly jump into the TCR runtime development using Substrate node bootstrapped using the <code>substrate-node-new</code> script. This guide is intended to walk you through the overall process of creating a DAppChain using Substrate. It does not cover the &quot;getting started&quot; and other basic concepts about Substrate. To get an overview of these concepts, it is highly recommended that you go through the <a href="https://substrate.dev/substrate-collectables-workshop/">Substrate Collectibles tutorial</a> before proceeding further.</p>
<p>Let's start with a new Substrate runtime node. We recommend going through the <a href="/docs/ru/getting-started/using-the-substrate-scripts">Substrate setup scripts tutorial</a> to spin up a hack-ready node runtime using the <code>substrate-node-new</code> script.</p>
<h2><a class="anchor" aria-hidden="true" id="step-2-pallet-trait-and-types"></a><a href="#step-2-pallet-trait-and-types" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 2: Pallet trait and types</h2>
<p>The first step towards building a Substrate runtime pallet is to define what other FRAME pallets we could use in our pallet. There are plenty of FRAME pallets that ship with the Substrate codebase and we recommend using them, when needed. To use any of the existing pallets, we need to import and specify them in the pallet trait of our custom pallet.</p>
<p>For example, in this runtime we need the capability to calculate and compare timestamps for the TCR parameters - apply stage length and commit stage length. We will use the <a href="https://github.com/paritytech/substrate/tree/master/frame/timestamp"><code>timestamp</code> FRAME pallet</a> to achieve this functionality.</p>
<p>Here's how the pallet configuration trait declaration for the TCR pallet looks like.</p>
<pre><code class="hljs css language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> Trait<span class="token punctuation">:</span> timestamp<span class="token punctuation">::</span>Trait <span class="token operator">+</span> token<span class="token punctuation">::</span>Trait <span class="token punctuation">{</span>
  <span class="token keyword">type</span> Event<span class="token punctuation">:</span> From<span class="token operator">&lt;</span>Event<span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">>></span> <span class="token operator">+</span> Into<span class="token operator">&lt;&lt;</span><span class="token keyword">Self</span> <span class="token keyword">as</span> system<span class="token punctuation">::</span>Trait<span class="token operator">></span><span class="token punctuation">::</span>Event<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>In the above snippet, we have the TCR pallet configuration trait inheriting from the <code>timestamp</code> pallet trait. In addition, it also inherits from the <code>token</code> pallet trait. It is important to import these pallets in your pallet before you use them in the pallet trait. In the following snippet we are importing the <code>timestamp</code> pallet from the SRML and the <code>token</code> pallet from the local crate.</p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> <span class="token punctuation">{</span>system<span class="token punctuation">::</span>ensure_signed<span class="token punctuation">,</span> timestamp<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span>token<span class="token punctuation">;</span>
</code></pre>
<p>The token pallet is another custom pallet that we need in order to support the token functionality for TCR curation functions. We would not be going into the implementation details of the <code>token</code> pallet in this guide as its code is pretty much self explanatory. Basically, the <code>token</code> pallet implements the ERC20 interface with some additional functions (lock and unlock). It is available as part of the TCR sample code base <a href="https://github.com/substrate-developer-hub/substrate-tcr/blob/master/runtime/src/token.rs">here</a>.</p>
<p>Remember to add references of your <code>token.rs</code> and <code>tcr.rs</code> pallets to the <code>lib.rs</code>, and add them to the <code>construct_runtime!</code> macro.</p>
<h2><a class="anchor" aria-hidden="true" id="step-3-declaring-the-runtime-storage"></a><a href="#step-3-declaring-the-runtime-storage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 3: Declaring the runtime storage</h2>
<p>The first thing we would want to do is define the storage for our TCR runtime.</p>
<p>When building a DApp or a DAppChain it is very important to decide what gets stored on-chain and what doesn't. It is recommended that you store on-chain only the data which is critical for conflict resolution; anything else can and should be stored off-chain. Properly defined storage is important for your chain's economic security in order to match resources paid by the user with resources provided by the network. If the storage items become large or unwieldy to deal with, then the transactions will become complex, risking an economic denial of service attack on your chain.</p>
<p>For the TCR runtime, let's see what could be the least amount of information stored on chain. To perform the basic curation operations for the TCR, we would store collections of listings (the registry), challenges, polls and votes. We would also need the TCR parameters to be stored as storage values.</p>
<h3><a class="anchor" aria-hidden="true" id="data-structures-for-on-chain-tcr-data"></a><a href="#data-structures-for-on-chain-tcr-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Data structures for on-chain TCR data</h3>
<p>First, to store the details for listings, challenges, polls and votes we would be defining the respective data structures using <code>Struct</code>.</p>
<pre><code class="hljs css language-rust"><span class="token attribute attr-name">#[derive(Encode, Decode, Default, Clone, PartialEq)]</span>
<span class="token attribute attr-name">#[cfg_attr(feature = "std", derive(Debug))]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Listing<span class="token operator">&lt;</span>U<span class="token punctuation">,</span> V<span class="token punctuation">,</span> W<span class="token operator">></span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token operator">></span><span class="token punctuation">,</span>
  deposit<span class="token punctuation">:</span> U<span class="token punctuation">,</span>
  owner<span class="token punctuation">:</span> V<span class="token punctuation">,</span>
  application_expiry<span class="token punctuation">:</span> W<span class="token punctuation">,</span>
  whitelisted<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
  challenge_id<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Encode, Decode, Default, Clone, PartialEq)]</span>
<span class="token attribute attr-name">#[cfg_attr(feature = "std", derive(Debug))]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Challenge<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> U<span class="token punctuation">,</span> V<span class="token punctuation">,</span> W<span class="token operator">></span> <span class="token punctuation">{</span>
  listing_hash<span class="token punctuation">:</span> T<span class="token punctuation">,</span>
  deposit<span class="token punctuation">:</span> U<span class="token punctuation">,</span>
  owner<span class="token punctuation">:</span> V<span class="token punctuation">,</span>
  voting_ends<span class="token punctuation">:</span> W<span class="token punctuation">,</span>
  resolved<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
  reward_pool<span class="token punctuation">:</span> U<span class="token punctuation">,</span>
  total_tokens<span class="token punctuation">:</span> U
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Encode, Decode, Default, Clone, PartialEq)]</span>
<span class="token attribute attr-name">#[cfg_attr(feature = "std", derive(Debug))]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Vote<span class="token operator">&lt;</span>U<span class="token operator">></span> <span class="token punctuation">{</span>
  value<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
  deposit<span class="token punctuation">:</span> U<span class="token punctuation">,</span>
  claimed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Encode, Decode, Default, Clone, PartialEq)]</span>
<span class="token attribute attr-name">#[cfg_attr(feature = "std", derive(Debug))]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Poll<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> U<span class="token operator">></span> <span class="token punctuation">{</span>
  listing_hash<span class="token punctuation">:</span> T<span class="token punctuation">,</span>
  votes_for<span class="token punctuation">:</span> U<span class="token punctuation">,</span>
  votes_against<span class="token punctuation">:</span> U<span class="token punctuation">,</span>
  passed<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
<p>These structs have generic type parameters so that we can use any implementation of the respective types. The following sub-section describes how we are instantiating collections of these structs where we define the exact type in place of generic parameters. The <code>Moment</code> type comes from the <code>timestamp</code> pallet and the <code>TokenBalance</code> type comes from the <code>token</code> pallet.</p>
<h3><a class="anchor" aria-hidden="true" id="storage-declaration-using-the-decl_storage-macro"></a><a href="#storage-declaration-using-the-decl_storage-macro" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Storage declaration using the <code>decl_storage</code> macro</h3>
<p>Here's how the <code>decl_storage</code> macro looks for the TCR runtime. The comments describe each of the storage items.</p>
<pre><code class="hljs css language-rust"><span class="token macro-rules function">decl_storage!</span> <span class="token punctuation">{</span>
 <span class="token keyword">trait</span>   Store <span class="token keyword">for</span> Module<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Trait<span class="token operator">></span> <span class="token keyword">as</span> Tcr <span class="token punctuation">{</span>

    <span class="token comment">// stores the owner in the genesis config</span>
    Owner <span class="token function">get</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> T<span class="token punctuation">::</span>AccountId<span class="token punctuation">;</span>

    <span class="token comment">// TCR parameter - minimum deposit</span>
    MinDeposit <span class="token function">get</span><span class="token punctuation">(</span>min_deposit<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>TokenBalance<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment">// TCR parameter - apply stage length - deadline for challenging before a listing gets accepted</span>
    ApplyStageLen <span class="token function">get</span><span class="token punctuation">(</span>apply_stage_len<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>Moment<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment">// TCR parameter - commit stage length - deadline for voting before a challenge gets resolved</span>
    CommitStageLen <span class="token function">get</span><span class="token punctuation">(</span>commit_stage_len<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>Moment<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment">// the TCR - list of proposals</span>
    Listings <span class="token function">get</span><span class="token punctuation">(</span>listings<span class="token punctuation">)</span><span class="token punctuation">:</span> map T<span class="token punctuation">::</span>Hash <span class="token operator">=></span> Listing<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>TokenBalance<span class="token punctuation">,</span> T<span class="token punctuation">::</span>AccountId<span class="token punctuation">,</span> T<span class="token punctuation">::</span>Moment<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment">// to make querying of listings easier, maintaining a list of indexes and corresponding listing hashes</span>
    ListingCount <span class="token function">get</span><span class="token punctuation">(</span>listing_count<span class="token punctuation">)</span><span class="token punctuation">:</span> u32<span class="token punctuation">;</span>
    ListingIndexHash <span class="token function">get</span><span class="token punctuation">(</span>index_hash<span class="token punctuation">)</span><span class="token punctuation">:</span> map u32 <span class="token operator">=></span> T<span class="token punctuation">::</span>Hash<span class="token punctuation">;</span>

    <span class="token comment">// global nonce for poll count</span>
    PollNonce <span class="token function">get</span><span class="token punctuation">(</span>poll_nonce<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> u32<span class="token punctuation">;</span>

    <span class="token comment">// challenges</span>
    Challenges <span class="token function">get</span><span class="token punctuation">(</span>challenges<span class="token punctuation">)</span><span class="token punctuation">:</span> map u32 <span class="token operator">=></span> Challenge<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>Hash<span class="token punctuation">,</span> T<span class="token punctuation">::</span>TokenBalance<span class="token punctuation">,</span> T<span class="token punctuation">::</span>AccountId<span class="token punctuation">,</span> T<span class="token punctuation">::</span>Moment<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment">// polls</span>
    Polls <span class="token function">get</span><span class="token punctuation">(</span>polls<span class="token punctuation">)</span><span class="token punctuation">:</span> map u32 <span class="token operator">=></span> Poll<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>Hash<span class="token punctuation">,</span> T<span class="token punctuation">::</span>TokenBalance<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token comment">// votes</span>
    <span class="token comment">// mapping is between a tuple of (poll id, Account Id) and a vec of votes</span>
    <span class="token comment">// poll and vote have a 1:n relationship</span>
    Votes <span class="token function">get</span><span class="token punctuation">(</span>votes<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token function">map</span> <span class="token punctuation">(</span>u32<span class="token punctuation">,</span> T<span class="token punctuation">::</span>AccountId<span class="token punctuation">)</span> <span class="token operator">=></span> Vote<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>TokenBalance<span class="token operator">></span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>As you can see, in addition to the storage items mentioned before, we have a few more storage items (<code>ListingCount</code>, <code>ListingIndexHash</code>) to make the data querying easier. These are completely optional and are not required by the TCR runtime for its core functionality.</p>
<h3><a class="anchor" aria-hidden="true" id="using-the-genesis-config"></a><a href="#using-the-genesis-config" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using the genesis config</h3>
<p>The genesis config is the state of the chain before the first block. This is useful in scenarios when we want to use some parameters needed for subsequent transactions. For example, the TCR parameters are needed before any of the listings can be applied.</p>
<p>In Substrate, a storage value can be marked as part of the genesis config by adding the <code>config()</code> call to its declaration. In the TCR runtime, we have the following as part of the genesis config. Note that each of the declarations has <code>config()</code> in it.</p>
<pre><code class="hljs css language-rust"><span class="token comment">// stores the owner in the genesis config</span>
Owner <span class="token function">get</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> T<span class="token punctuation">::</span>AccountId<span class="token punctuation">;</span>

<span class="token comment">// TCR parameter - minimum deposit</span>
MinDeposit <span class="token function">get</span><span class="token punctuation">(</span>min_deposit<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>TokenBalance<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment">// TCR parameter - apply stage length - deadline for challenging before a listing gets accepted</span>
ApplyStageLen <span class="token function">get</span><span class="token punctuation">(</span>apply_stage_len<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>Moment<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment">// TCR parameter - commit stage length - deadline for voting before a challenge gets resolved</span>
CommitStageLen <span class="token function">get</span><span class="token punctuation">(</span>commit_stage_len<span class="token punctuation">)</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>T<span class="token punctuation">::</span>Moment<span class="token operator">></span><span class="token punctuation">;</span>
</code></pre>
<p>Marking a storage value as <code>config()</code> is just enabling it to be used as genesis config. To use it as the state before the first block, we also need to set a value for it.</p>
<p>To set the values for genesis config, we need to make some edits in the <code>chain_spec.rs</code> file.</p>
<p>First, we need to add a type name for the genesis config in the template runtime import. In the code snippet below, we have added <code>TcrConfig</code> in the runtime import for representing the genesis config of TCR runtime pallet</p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> node_template_runtime<span class="token punctuation">::</span><span class="token punctuation">{</span>
    AccountId<span class="token punctuation">,</span> GenesisConfig<span class="token punctuation">,</span> ConsensusConfig<span class="token punctuation">,</span> TimestampConfig<span class="token punctuation">,</span> BalancesConfig<span class="token punctuation">,</span>
    SudoConfig<span class="token punctuation">,</span> IndicesConfig<span class="token punctuation">,</span> TcrConfig
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Second, we need to add a section in the <code>testnet_genesis</code> function in the same <code>chain_spec.rs</code> file. For the TCR runtime and its genesis config parameters, here's how it looks.</p>
<pre><code class="hljs css language-rust">tcr<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>TcrConfig <span class="token punctuation">{</span>
    <span class="token comment">// owner account id</span>
    owner<span class="token punctuation">:</span> ed25519<span class="token punctuation">::</span>Pair<span class="token punctuation">::</span><span class="token function">from_seed</span><span class="token punctuation">(</span><span class="token string">b"Alice "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">public</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// min deposit for proposals</span>
    min_deposit<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>

    <span class="token comment">// challenge time limit - for testing its set to 2 mins (120 sec)</span>
    apply_stage_len<span class="token punctuation">:</span> <span class="token number">120</span><span class="token punctuation">,</span>

    <span class="token comment">// voting time limit - for testing its set to 4 mins (240 sec)</span>
    commit_stage_len<span class="token punctuation">:</span> <span class="token number">240</span><span class="token punctuation">,</span>

    <span class="token comment">// initial poll/challenge set to 1</span>
    <span class="token comment">// to avoid 0 values</span>
    poll_nonce<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Here, we have assigned values to each of the storage items that were marked with <code>config()</code> in the runtime storage declaration inside the <code>decl_storage</code> macro. For example, the value for minimum deposit is 100 and this will be used right from the beginning of the chain so that the deposit on any new listing being applied can be validated against this value.</p>
<p>You can see the <code>chain_spec.rs</code> file with all the required edits <a href="https://github.com/substrate-developer-hub/substrate-tcr/blob/master/src/chain_spec.rs">here</a>.</p>
<p>This also concludes the work needed on the storage declaration and setup.</p>
<h2><a class="anchor" aria-hidden="true" id="step-4-declaring-events"></a><a href="#step-4-declaring-events" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 4: Declaring Events</h2>
<p>The next step for our runtime pallet development is declaring its events. In general, we need events so that the external world can listen to updates on the blockchain. If we do not have proper events in our runtime, the users would end up querying a lot of on-chain data.</p>
<p>Also, it is important to note that the runtime functions in Substrate do not return values on success. Their return value is either empty or an error message. Because of this, it becomes even more important to have events with the right parameters so that the state changes can be communicated to the clients and hence, users.</p>
<p>We can also use the events to build an off-chain cache of the on-chain data. This cache can then be used to query and analyze data in a more performant way. We will cover more on this in Part 3 of this guide.</p>
<p>For our TCR runtime pallet, we would have events to communicate updates on listings - proposal, challenge, vote, resolution, accepted/rejected and rewards claim. All these are logical steps in the life-cycle of a listing and corresponding challenges and should be communicated to the outside world.</p>
<p>In general, when developing a runtime pallet, you should ask yourself this question - &quot;What kind of updates will the client or the external user be interested in when using this runtime?&quot; Ideally, all these updates should be communicated as events.</p>
<p>For our TCR runtime, we have the following events declared using the <code>decl_event</code> macro.</p>
<pre><code class="hljs css language-rust"><span class="token function">decl_event!</span><span class="token punctuation">(</span>
    <span class="token keyword">pub</span> <span class="token keyword">enum</span> Event<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">where</span>
        AccountId <span class="token operator">=</span> <span class="token operator">&lt;</span>T <span class="token keyword">as</span> system<span class="token punctuation">::</span>Trait<span class="token operator">></span><span class="token punctuation">::</span>AccountId<span class="token punctuation">,</span>
        Balance <span class="token operator">=</span> <span class="token operator">&lt;</span>T <span class="token keyword">as</span> token<span class="token punctuation">::</span>Trait<span class="token operator">></span><span class="token punctuation">::</span>TokenBalance<span class="token punctuation">,</span>
        Hash <span class="token operator">=</span> <span class="token operator">&lt;</span>T <span class="token keyword">as</span> system<span class="token punctuation">::</span>Trait<span class="token operator">></span><span class="token punctuation">::</span>Hash<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// when a listing is proposed</span>
      <span class="token function">Proposed</span><span class="token punctuation">(</span>AccountId<span class="token punctuation">,</span> Hash<span class="token punctuation">,</span> Balance<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// when a listing is challenged</span>
      <span class="token function">Challenged</span><span class="token punctuation">(</span>AccountId<span class="token punctuation">,</span> Hash<span class="token punctuation">,</span> u32<span class="token punctuation">,</span> Balance<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// when a challenge is voted on</span>
      <span class="token function">Voted</span><span class="token punctuation">(</span>AccountId<span class="token punctuation">,</span> u32<span class="token punctuation">,</span> Balance<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// when a challenge is resolved</span>
      <span class="token function">Resolved</span><span class="token punctuation">(</span>Hash<span class="token punctuation">,</span> u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// when a listing is accepted in the registry</span>
      <span class="token function">Accepted</span><span class="token punctuation">(</span>Hash<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// when a listing is rejected from the registry</span>
      <span class="token function">Rejected</span><span class="token punctuation">(</span>Hash<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// when a vote reward is claimed for a challenge</span>
      <span class="token function">Claimed</span><span class="token punctuation">(</span>AccountId<span class="token punctuation">,</span> u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>At this point, we have our storage, genesis config, and events sorted. We are now good to proceed with the implementation of the runtime business logic.</p>
<h2><a class="anchor" aria-hidden="true" id="step-5-pallet-business-logic"></a><a href="#step-5-pallet-business-logic" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Step 5: Pallet business logic</h2>
<p>There is a reason why we are doing the business logic at the end. At this point, it becomes very clear what we intend to store and what we plan to communicate (events) in our pallet. This clarity can help a lot in optimizing the business logic. Let's begin.</p>
<h3><a class="anchor" aria-hidden="true" id="propose-a-listing"></a><a href="#propose-a-listing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Propose a listing</h3>
<p>The first function that our TCR runtime pallet needs to expose is to allow the proposal of a listing to the registry. In this function, we take as input the listing name and deposit. We then validate this input as per the TCR config parameters stored as genesis config. Then we deduct (lock) the deposit amount from the sender's balance using the <code>token</code> pallet. Finally, we store the listing as an instance of the <code>Listing</code> struct inside the <code>Listings</code> storage map.</p>
<p>Here's how the <code>Propose</code> function is implemented,</p>
<pre><code class="hljs css language-rust"><span class="token comment">// propose a listing on the registry</span>
<span class="token comment">// takes the listing name (data) as a byte vector</span>
<span class="token comment">// takes deposit as stake backing the listing</span>
<span class="token comment">// checks if the stake is less than minimum deposit needed</span>
<span class="token keyword">fn</span> <span class="token function">propose</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> data<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token operator">></span><span class="token punctuation">,</span> <span class="token attribute attr-name">#[compact]</span> deposit<span class="token punctuation">:</span> T<span class="token punctuation">::</span>TokenBalance<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sender <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token comment">// to avoid byte arrays with unlimited length</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token string">"listing data cannot be more than 256 bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> min_deposit <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">min_deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"Min deposit not set"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>deposit <span class="token operator">>=</span> min_deposit<span class="token punctuation">,</span> <span class="token string">"deposit should be more than min_deposit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// set application expiry for the listing</span>
  <span class="token comment">// using the `Timestamp` FRAME pallet for getting the block timestamp</span>
  <span class="token comment">// generating a future timestamp by adding the apply stage length</span>
  <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token operator">&lt;</span>timestamp<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> apply_stage_len <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">apply_stage_len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"Apply stage length not set."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> app_exp <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">checked_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>apply_stage_len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"Overflow when setting application expiry."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> hashed <span class="token operator">=</span> <span class="token operator">&lt;</span>T <span class="token keyword">as</span> system<span class="token punctuation">::</span>Trait<span class="token operator">></span><span class="token punctuation">::</span>Hashing<span class="token punctuation">::</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> listing_id <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">listing_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// create a new listing instance</span>
  <span class="token keyword">let</span> listing <span class="token operator">=</span> Listing <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> listing_id<span class="token punctuation">,</span>
    data<span class="token punctuation">,</span>
    deposit<span class="token punctuation">,</span>
    owner<span class="token punctuation">:</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    whitelisted<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
    challenge_id<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    application_expiry<span class="token punctuation">:</span> app_exp<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">ensure!</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">&lt;</span>Listings<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>hashed<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Listing already exists"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// deduct the deposit for application</span>
  <span class="token operator">&lt;</span>token<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deposit<span class="token punctuation">,</span> hashed<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token operator">&lt;</span>ListingCount<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>listing_id <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>Listings<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span>hashed<span class="token punctuation">,</span> listing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>ListingIndexHash<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span>listing_id<span class="token punctuation">,</span> hashed<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// let the world know</span>
  <span class="token comment">// raise the event</span>
  <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Proposed</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> hashed<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deposit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  runtime_io<span class="token punctuation">::</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Listing created!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>It is worth noting that we are doing all the checks and validations before touching the storage. This is <strong>very important</strong> as the state of the blockchain cannot be reversed if the logic fails or errors out. We need to be extremely careful before updating the storage. This is well described in the <a href="https://github.com/substrate-developer-hub/substrate-collectables-workshop/blob/master/2/tracking-all-kitties.md#verify-first-write-last">Substrate-Collectibles tutorial</a> also.</p>
<p>If you are using external pallets in your pallet, make sure to check whether the functions from these external pallets are doing any validations. If yes, make these function calls before updating any storage in your pallet. In this case, we are calling the <code>lock</code> function of the <code>token</code> pallet from the <code>propose</code> function of the <code>TCR</code> pallet. The <code>lock</code> function is verifying if the token balance of the proposer (origin) is more than the deposit. That's why we are calling it before inserting the listing. The <code>lock</code> function also updates storage (locking the user's funds), so it is important not to have any more operations that can fail after the user's funds are locked.</p>
<p>Finally, we raise the <code>Proposed</code> event to communicate to the external world that a new listing has been proposed in the registry.</p>
<h3><a class="anchor" aria-hidden="true" id="challenge-and-vote"></a><a href="#challenge-and-vote" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Challenge and Vote</h3>
<p>Similar to how we have implemented the <code>propose</code> function above, we implement the <code>challenge</code> and <code>vote</code> functions also. We follow the same pattern of doing all the checks and validations and then recording the updated state in the storage.</p>
<p>In the <strong>challenge</strong> function, we check if the listing exists and if it is still in the apply stage period. We also check if the deposit for challenge is at least equal to that of the listing. We then lock the deposit for challenge and store a new instance of the <code>Challenge</code> struct in the <code>Challenges</code> storage map. We also update the listing with the <code>challenge_id</code>. Finally we raise the <code>Challenged</code> event.</p>
<pre><code class="hljs css language-rust"><span class="token comment">// challenge a listing</span>
<span class="token comment">// for simplicity, only three checks are being done</span>
<span class="token comment">//    a. if the listing exists</span>
<span class="token comment">//    c. if the challenger is not the owner of the listing</span>
<span class="token comment">//    b. if enough deposit is sent for challenge</span>
<span class="token keyword">fn</span> <span class="token function">challenge</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> listing_id<span class="token punctuation">:</span> u32<span class="token punctuation">,</span> <span class="token attribute attr-name">#[compact]</span> deposit<span class="token punctuation">:</span> T<span class="token punctuation">::</span>TokenBalance<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sender <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token function">ensure!</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ListingIndexHash<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>listing_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Listing not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> listing_hash <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">index_hash</span><span class="token punctuation">(</span>listing_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> listing <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">listings</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">ensure!</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>challenge_id <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Listing is already challenged."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>owner <span class="token operator">!=</span> sender<span class="token punctuation">,</span> <span class="token string">"You cannot challenge your own listing."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>deposit <span class="token operator">>=</span> listing<span class="token punctuation">.</span>deposit<span class="token punctuation">,</span> <span class="token string">"Not enough deposit to challenge."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// get current time</span>
  <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token operator">&lt;</span>timestamp<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// get commit stage length</span>
  <span class="token keyword">let</span> commit_stage_len <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">commit_stage_len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"Commit stage length not set."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> voting_exp <span class="token operator">=</span> now<span class="token punctuation">.</span><span class="token function">checked_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>commit_stage_len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"Overflow when setting voting expiry."</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token comment">// check apply stage length not passed</span>
  <span class="token comment">// ensure that now &lt;= listing.application_expiry</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>application_expiry <span class="token operator">></span> now<span class="token punctuation">,</span> <span class="token string">"Apply stage length has passed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> challenge <span class="token operator">=</span> Challenge <span class="token punctuation">{</span>
    listing_hash<span class="token punctuation">,</span>
    deposit<span class="token punctuation">,</span>
    owner<span class="token punctuation">:</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    voting_ends<span class="token punctuation">:</span> voting_exp<span class="token punctuation">,</span>
    resolved<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
    reward_pool<span class="token punctuation">:</span> <span class="token operator">&lt;</span>T<span class="token punctuation">::</span>TokenBalance <span class="token keyword">as</span> As<span class="token operator">&lt;</span>u64<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">sa</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    total_tokens<span class="token punctuation">:</span> <span class="token operator">&lt;</span>T<span class="token punctuation">::</span>TokenBalance <span class="token keyword">as</span> As<span class="token operator">&lt;</span>u64<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">sa</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> poll <span class="token operator">=</span> Poll <span class="token punctuation">{</span>
    listing_hash<span class="token punctuation">,</span>
    votes_for<span class="token punctuation">:</span> listing<span class="token punctuation">.</span>deposit<span class="token punctuation">,</span>
    votes_against<span class="token punctuation">:</span> deposit<span class="token punctuation">,</span>
    passed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// deduct the deposit for challenge</span>
  <span class="token operator">&lt;</span>token<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deposit<span class="token punctuation">,</span> listing_hash<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token comment">// global poll nonce</span>
  <span class="token comment">// helps keep the count of challenges and in mapping votes</span>
  <span class="token keyword">let</span> poll_nonce <span class="token operator">=</span> <span class="token operator">&lt;</span>PollNonce<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// add a new challenge and the corresponding poll in the respective collections</span>
  <span class="token operator">&lt;</span>Challenges<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span>poll_nonce<span class="token punctuation">,</span> challenge<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>Polls<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span>poll_nonce<span class="token punctuation">,</span> poll<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// update listing with challenge id</span>
  <span class="token operator">&lt;</span>Listings<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">mutate</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">,</span> <span class="token closure-params"><span class="token punctuation">|</span>listing<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    listing<span class="token punctuation">.</span>challenge_id <span class="token operator">=</span> poll_nonce<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// update the poll nonce</span>
  <span class="token operator">&lt;</span>PollNonce<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">put</span><span class="token punctuation">(</span>poll_nonce <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// raise the event</span>
  <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Challenged</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> listing_hash<span class="token punctuation">,</span> poll_nonce<span class="token punctuation">,</span> deposit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  runtime_io<span class="token punctuation">::</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Challenge created!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Similarly, in the <strong>vote</strong> function we check for existence of the listing and challenge. We also check if the commit stage period has passed or not. Based on the vote value (true or false) we add the vote deposit to either <code>votes_for</code> or <code>votes_against</code> fields in the corresponding poll instance. We then store a new instance of the <code>Vote</code> struct inside the <code>Votes</code> map and also raise the <code>Voted</code> event.</p>
<pre><code class="hljs css language-rust"><span class="token comment">// registers a vote for a particular challenge</span>
<span class="token comment">// checks if the listing is challenged and</span>
<span class="token comment">// if the commit stage length has not passed</span>
<span class="token comment">// to keep it simple, we just store the choice as a bool - true: aye; false: nay</span>
<span class="token keyword">fn</span> <span class="token function">vote</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> challenge_id<span class="token punctuation">:</span> u32<span class="token punctuation">,</span> value<span class="token punctuation">:</span> bool<span class="token punctuation">,</span> <span class="token attribute attr-name">#[compact]</span> deposit<span class="token punctuation">:</span> T<span class="token punctuation">::</span>TokenBalance<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sender <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token comment">// check if listing is challenged</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Challenges<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Challenge does not exist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> challenge <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">challenges</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>resolved <span class="token operator">==</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"Challenge is already resolved."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// check commit stage length not passed</span>
  <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token operator">&lt;</span>timestamp<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>voting_ends <span class="token operator">></span> now<span class="token punctuation">,</span> <span class="token string">"Commit stage length has passed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// deduct the deposit for vote</span>
  <span class="token operator">&lt;</span>token<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">lock</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> deposit<span class="token punctuation">,</span> challenge<span class="token punctuation">.</span>listing_hash<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token keyword">mut</span> poll_instance <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">polls</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// based on vote value, increase the count of votes (for or against)</span>
  <span class="token keyword">match</span> value <span class="token punctuation">{</span>
    <span class="token keyword">true</span> <span class="token operator">=></span> poll_instance<span class="token punctuation">.</span>votes_for <span class="token operator">+=</span> deposit<span class="token punctuation">,</span>
    <span class="token keyword">false</span> <span class="token operator">=></span> poll_instance<span class="token punctuation">.</span>votes_against <span class="token operator">+=</span> deposit<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// create a new vote instance with the input params</span>
  <span class="token keyword">let</span> vote_instance <span class="token operator">=</span> Vote <span class="token punctuation">{</span>
    value<span class="token punctuation">,</span>
    deposit<span class="token punctuation">,</span>
    claimed<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// mutate polls collection to update the poll instance</span>
  <span class="token operator">&lt;</span>Polls<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">mutate</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">,</span> <span class="token operator">|</span>poll<span class="token operator">|</span> <span class="token operator">*</span>poll <span class="token operator">=</span> poll_instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// insert new vote into votes collection</span>
  <span class="token operator">&lt;</span>Votes<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">,</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> vote_instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// raise the event</span>
  <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Voted</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> challenge_id<span class="token punctuation">,</span> deposit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  runtime_io<span class="token punctuation">::</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Vote created!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="resolve"></a><a href="#resolve" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resolve</h3>
<p>Once an unchallenged listing is out of the apply stage period or a challenged listing is out of the commit period, the <code>resolve</code> function can be called on it. Anyone can call the resolve function as it does not involve any staking.</p>
<p>In the resolve function, we check for several conditions including,</p>
<ul>
<li>If the listing exists and whether it is in apply stage period</li>
<li>If a challenge exists for the listing and whether it is in commit stage period</li>
<li>If the votes are in favor of white-listing</li>
</ul>
<p>Based on the outcome of these checks we update the listing status to accepted or rejected by setting the <code>listing.whitelisted</code> value to true or false. We also raise the <code>Resolved</code> and <code>Accepted/Rejected</code> events.</p>
<p>In addition, we also update the token and reward values in the corresponding <code>Challenge</code> instance.</p>
<pre><code class="hljs css language-rust"><span class="token comment">// resolves the status of a listing</span>
<span class="token keyword">fn</span> <span class="token function">resolve</span><span class="token punctuation">(</span>_origin<span class="token punctuation">,</span> listing_id<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>ListingIndexHash<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>listing_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Listing not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> listing_hash <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">index_hash</span><span class="token punctuation">(</span>listing_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> listing <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">listings</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token operator">&lt;</span>timestamp<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> challenge<span class="token punctuation">;</span>
  <span class="token keyword">let</span> poll<span class="token punctuation">;</span>

  <span class="token comment">// check if listing is challenged</span>
  <span class="token keyword">if</span> listing<span class="token punctuation">.</span>challenge_id <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// challenge</span>
    challenge <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">challenges</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    poll <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">polls</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// check commit stage length has passed</span>
    <span class="token function">ensure!</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>voting_ends <span class="token operator">&lt;</span> now<span class="token punctuation">,</span> <span class="token string">"Commit stage length has not passed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// no challenge</span>
    <span class="token comment">// check if apply stage length has passed</span>
    <span class="token function">ensure!</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>application_expiry <span class="token operator">&lt;</span> now<span class="token punctuation">,</span> <span class="token string">"Apply stage length has not passed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// update listing status</span>
    <span class="token operator">&lt;</span>Listings<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">mutate</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">,</span> <span class="token closure-params"><span class="token punctuation">|</span>listing<span class="token punctuation">|</span></span>
    <span class="token punctuation">{</span>
      listing<span class="token punctuation">.</span>whitelisted <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Accepted</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> <span class="token keyword">mut</span> whitelisted <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

  <span class="token comment">// mutate polls collection to update the poll instance</span>
  <span class="token operator">&lt;</span>Polls<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">mutate</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>challenge_id<span class="token punctuation">,</span> <span class="token closure-params"><span class="token punctuation">|</span>poll<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> poll<span class="token punctuation">.</span>votes_for <span class="token operator">>=</span> poll<span class="token punctuation">.</span>votes_against <span class="token punctuation">{</span>
        poll<span class="token punctuation">.</span>passed <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        whitelisted <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        poll<span class="token punctuation">.</span>passed <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// update listing status</span>
  <span class="token operator">&lt;</span>Listings<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">mutate</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">,</span> <span class="token closure-params"><span class="token punctuation">|</span>listing<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    listing<span class="token punctuation">.</span>whitelisted <span class="token operator">=</span> whitelisted<span class="token punctuation">;</span>
    listing<span class="token punctuation">.</span>challenge_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// update challenge</span>
  <span class="token operator">&lt;</span>Challenges<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">mutate</span><span class="token punctuation">(</span>listing<span class="token punctuation">.</span>challenge_id<span class="token punctuation">,</span> <span class="token closure-params"><span class="token punctuation">|</span>challenge<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
    challenge<span class="token punctuation">.</span>resolved <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> whitelisted <span class="token operator">==</span> <span class="token keyword">true</span> <span class="token punctuation">{</span>
      challenge<span class="token punctuation">.</span>total_tokens <span class="token operator">=</span> poll<span class="token punctuation">.</span>votes_for<span class="token punctuation">;</span>
      challenge<span class="token punctuation">.</span>reward_pool <span class="token operator">=</span> challenge<span class="token punctuation">.</span>deposit <span class="token operator">+</span> poll<span class="token punctuation">.</span>votes_against<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      challenge<span class="token punctuation">.</span>total_tokens <span class="token operator">=</span> poll<span class="token punctuation">.</span>votes_against<span class="token punctuation">;</span>
      challenge<span class="token punctuation">.</span>reward_pool <span class="token operator">=</span> listing<span class="token punctuation">.</span>deposit <span class="token operator">+</span> poll<span class="token punctuation">.</span>votes_for<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// raise appropriate event as per whitelisting status</span>
  <span class="token keyword">if</span> whitelisted <span class="token operator">==</span> <span class="token keyword">true</span> <span class="token punctuation">{</span>
    <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Accepted</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// if rejected, give challenge deposit back to the challenger</span>
    <span class="token operator">&lt;</span>token<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">unlock</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>owner<span class="token punctuation">,</span> challenge<span class="token punctuation">.</span>deposit<span class="token punctuation">,</span> listing_hash<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Rejected</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Resolved</span><span class="token punctuation">(</span>listing_hash<span class="token punctuation">,</span> listing<span class="token punctuation">.</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="claim-reward"></a><a href="#claim-reward" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Claim reward</h3>
<p>Once a listing is resolved, voting rewards can be claimed using the <code>claim_reward</code> function. In this function, we check if the caller (origin) has voted on a particular challenge or not. We then check if the challenge has been resolved or not. Based on these checks, we calculate the reward for the origin and call the <code>unlock</code> function using the <code>token</code> pallet. We also update the <code>Vote</code> instance with the claimed status to true so that the same reward cannot be claimed again. Finally, we raise the <code>Claimed</code> event.</p>
<p>It is important to note that the <code>claim_reward</code> function takes a <code>challenge_id</code> as an input parameter rather than a listing (unlike previous functions). Finding the right <code>challenge_id</code> for a listing should be done beforehand.</p>
<pre><code class="hljs css language-rust"><span class="token comment">// claim reward for a vote</span>
<span class="token keyword">fn</span> <span class="token function">claim_reward</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> challenge_id<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
  <span class="token keyword">let</span> sender <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token comment">// ensure challenge exists and has been resolved</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Challenges<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">exists</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Challenge not found."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> challenge <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">challenges</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>challenge<span class="token punctuation">.</span>resolved <span class="token operator">==</span> <span class="token keyword">true</span><span class="token punctuation">,</span> <span class="token string">"Challenge is not resolved."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// get the poll and vote instances</span>
  <span class="token comment">// reward depends on poll passed status and vote value</span>
  <span class="token keyword">let</span> poll <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">polls</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> vote <span class="token operator">=</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">votes</span><span class="token punctuation">(</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">,</span> sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ensure vote reward is not already claimed</span>
  <span class="token function">ensure!</span><span class="token punctuation">(</span>vote<span class="token punctuation">.</span>claimed <span class="token operator">==</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">"Vote reward has already been claimed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// if winning party, calculate reward and transfer</span>
  <span class="token keyword">if</span> poll<span class="token punctuation">.</span>passed <span class="token operator">==</span> vote<span class="token punctuation">.</span>value <span class="token punctuation">{</span>
        <span class="token keyword">let</span> reward_ratio <span class="token operator">=</span> challenge<span class="token punctuation">.</span>reward_pool<span class="token punctuation">.</span><span class="token function">checked_div</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>challenge<span class="token punctuation">.</span>total_tokens<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"overflow in calculating reward"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> reward <span class="token operator">=</span> reward_ratio<span class="token punctuation">.</span><span class="token function">checked_mul</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vote<span class="token punctuation">.</span>deposit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"overflow in calculating reward"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> total <span class="token operator">=</span> reward<span class="token punctuation">.</span><span class="token function">checked_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vote<span class="token punctuation">.</span>deposit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok_or</span><span class="token punctuation">(</span><span class="token string">"overflow in calculating reward"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token operator">&lt;</span>token<span class="token punctuation">::</span>Module<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">unlock</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> total<span class="token punctuation">,</span> challenge<span class="token punctuation">.</span>listing_hash<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>RawEvent<span class="token punctuation">::</span><span class="token function">Claimed</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> challenge_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// update vote reward claimed status</span>
    <span class="token operator">&lt;</span>Votes<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">::</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>challenge_id<span class="token punctuation">,</span> sender<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">|</span>vote<span class="token operator">|</span> vote<span class="token punctuation">.</span>claimed <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The core TCR flow is now complete with the <code>propose</code>, <code>challenge</code>, <code>vote</code>, <code>resolve</code>, and <code>claim_reward</code> functions. It can be further extended, as needed. Please note that what we have covered here is just a sample implementation of a subset of TCR functions. It is only for educational purposes and is not intended for real use-cases.</p>
<p>The code for the TCR runtime pallets - <code>tcr</code> and <code>token</code> covered in this part of the guide, is available <a href="https://github.com/substrate-developer-hub/substrate-tcr/tree/master/runtime/src">here</a>.</p>
<p>In the <a href="/docs/ru/tutorials/tcr/unit-testing-the-tcr-runtime-module">next part</a> of this guide, we will learn how to unit test the functions in a Substrate runtime.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#step-1-setup-and-prerequisites">Step 1: Setup and prerequisites</a></li><li><a href="#step-2-pallet-trait-and-types">Step 2: Pallet trait and types</a></li><li><a href="#step-3-declaring-the-runtime-storage">Step 3: Declaring the runtime storage</a><ul class="toc-headings"><li><a href="#data-structures-for-on-chain-tcr-data">Data structures for on-chain TCR data</a></li><li><a href="#storage-declaration-using-the-decl_storage-macro">Storage declaration using the <code>decl_storage</code> macro</a></li><li><a href="#using-the-genesis-config">Using the genesis config</a></li></ul></li><li><a href="#step-4-declaring-events">Step 4: Declaring Events</a></li><li><a href="#step-5-pallet-business-logic">Step 5: Pallet business logic</a><ul class="toc-headings"><li><a href="#propose-a-listing">Propose a listing</a></li><li><a href="#challenge-and-vote">Challenge and Vote</a></li><li><a href="#resolve">Resolve</a></li><li><a href="#claim-reward">Claim reward</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/Substrate-logo.svg" alt="Substrate Developer Hub" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/ru/getting-started">Getting Started</a><a href="/ru/tutorials">Tutorials</a><a href="/rustdocs/v1.0/">Reference Docs</a><a href="/recipes/">Recipes</a></div><div><h5>Community</h5><a href="/ru/videos">Videos</a><a href="/ru/seminar">Substrate Seminar</a><a href="http://stackoverflow.com/questions/tagged/substrate" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://riot.im/app/#/room/!HzySYSaIhtyWrwiwEV:matrix.org">Riot Chat</a><a href="https://twitter.com/ParityTech" target="_blank" rel="noreferrer noopener">Twitter</a><a href="https://www.meetup.com/parity/" target="_blank" rel="noreferrer noopener">Events</a></div><div><h5>More</h5><a href="https://builders.parity.io/">Substrate Builders Program</a><a href="https://www.parity.io/blog/">Blog</a><a href="https://github.com/paritytech/substrate">Substrate GitHub</a><a href="https://github.com/substrate-developer-hub/">Developer Hub GitHub</a><a href="https://www.parity.io/privacy/">Privacy Policy</a><a href="#" id="cookie-settings">Cookie Settings<script>
              var cookieSettings = document.getElementById('cookie-settings');
              cookieSettings.onclick = function() {
                return klaro.show();
              };
              </script></a></div></section><section class="copyright">Copyright © 2020 Parity Technologies</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '5cd09916f4ba4c283b2d45ee7386fc34',
                indexName: 'substrate',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["language:ru"]}
              });
            </script></body></html>