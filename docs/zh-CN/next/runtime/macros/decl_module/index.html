<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>定义模块 · Substrate Developer Hub</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;The &lt;code&gt;decl_module!&lt;/code&gt; macro defines the public functions exposed by your module, which act as entry points to accessing your runtime. These functions should work together to build a &lt;em&gt;generally&lt;/em&gt; independent set of features and functionality which will be included with your blockchain&#x27;s final runtime. The main logic of the macro is defined &lt;a href=&quot;/rustdocs/v1.0/srml_support/macro.decl_module.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="zh-CN"/><meta property="og:title" content="定义模块 · Substrate Developer Hub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://substrate-developer-hub.github.io//"/><meta property="og:description" content="&lt;p&gt;The &lt;code&gt;decl_module!&lt;/code&gt; macro defines the public functions exposed by your module, which act as entry points to accessing your runtime. These functions should work together to build a &lt;em&gt;generally&lt;/em&gt; independent set of features and functionality which will be included with your blockchain&#x27;s final runtime. The main logic of the macro is defined &lt;a href=&quot;/rustdocs/v1.0/srml_support/macro.decl_module.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
"/><meta property="og:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/load.js"></script><script type="text/javascript" src="/js/config.js" defer=""></script><script type="text/javascript" src="/js/klaro.min.js" defer=""></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/zh-CN"><img class="logo" src="/img/Substrate-logo.svg" alt="Substrate Developer Hub"/><h2 class="headerTitleWithLogo">Substrate Developer Hub</h2></a><a href="/zh-CN/versions"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/zh-CN/docs" target="_self">文档</a></li><li class=""><a href="/rustdocs/v1.0/" target="_self">参考文档</a></li><li class=""><a href="/zh-CN/tutorials" target="_self">教程</a></li><li class=""><a href="/zh-CN/community" target="_self">社区</a></li><li class=""><a href="https://github.com/paritytech/substrate" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg" alt="Languages icon"/>中文</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/en/next/runtime/macros/decl_module">English</a></li><li><a href="/docs/ru/next/runtime/macros/decl_module">Русский</a></li><li><a href="https://crowdin.com/project/substrate-developer-hub" target="_blank" rel="noreferrer noopener">参与翻译</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://crowdin.com/project/substrate-developer-hub/zh-CN" target="_blank" rel="noreferrer noopener">Translate</a><h1 class="postHeaderTitle">定义模块</h1></header><article><div><span><p>The <code>decl_module!</code> macro defines the public functions exposed by your module, which act as entry points to accessing your runtime. These functions should work together to build a <em>generally</em> independent set of features and functionality which will be included with your blockchain's final runtime. The main logic of the macro is defined <a href="/rustdocs/v1.0/srml_support/macro.decl_module.html">here</a>.</p>
<p>Each of the different components in the <a href="https://github.com/paritytech/substrate/tree/master/srml">Substrate Runtime Module Library</a> (SRML) is an example of a Runtime Module.</p>
<p>We will start by looking at the <code>decl_module</code> macro in it's most simple form:</p>
<pre><code class="hljs css language-rust"><span class="token macro-rules function">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> Module<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Trait<span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> Call <span class="token keyword">where</span> origin<span class="token punctuation">:</span> T<span class="token punctuation">:</span><span class="token punctuation">:</span>Origin <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">set_value</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> value<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _sender <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span>?<span class="token punctuation">;</span>
      <span class="token operator">&lt;</span>Value<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Note that for the purposes of this example, we are taking advantage of a single storage item created by the <code>decl_storage</code> macro. We will omit the storage declaration for the purposes of this article, but you can learn more about <code>decl_storage</code> in our documentation <a href="/rustdocs/v1.0/srml_support_procedural/macro.decl_storage.html">here</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="declaration-of-the-module-type"></a><a href="#declaration-of-the-module-type" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Declaration of the Module Type</h2>
<p>The first line in the <code>decl_module</code> macro defines the <code>Module</code> type which is used by the <code>construct_runtime</code> macro:</p>
<pre><code class="hljs css language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> Module<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Trait<span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> Call <span class="token keyword">where</span> origin<span class="token punctuation">:</span> T<span class="token punctuation">:</span><span class="token punctuation">:</span>Origin
</code></pre>
<p>This line is using custom syntax expected by the <code>decl_module</code> macro and is not standard Rust. For most module development, you will not need to modify this line.</p>
<p><code>Module</code> is defined to use the generic <code>T</code> which represents the <code>Trait</code> type defined for the module. Functions inside the Module can then use this generic to access custom types.</p>
<p>An <code>enum</code> is also defined with the name <code>Call</code>, which is expected by the <code>construct_runtime</code> macro. The functions defined in <code>decl_module</code> are dispatched into this <code>enum</code>, with the function names and parameters clearly defined. This structure is publicly exposed by your runtime to allow for downstream APIs and front-ends to easily interact.</p>
<p>Finally, <code>origin: T::Origin</code> is a optimization made to simplify the parameter definition of functions in <code>decl_module</code>. We are just saying that the <code>origin</code> variable used in the function has type <code>Trait::Origin</code> which is usually defined by the <code>system</code> module.</p>
<h2><a class="anchor" aria-hidden="true" id="functional-requirements"></a><a href="#functional-requirements" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Functional Requirements</h2>
<p>To ensure that your module functions as intended, you need to follow these rules when developing module functions.</p>
<h3><a class="anchor" aria-hidden="true" id="must-not-panic"></a><a href="#must-not-panic" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Must Not Panic</h3>
<p>Under no circumstances should a module function <code>panic</code>. A <code>panic</code> in your runtime module can lead to a potential denial of service (DoS) attack. If your runtime has the ability to panic, a malicious user could send a transaction which does a lot of computational work, cause the runtime to panic, and then because of the panic, avoid paying any fees related to that computational work. None of the computation done before the panic gets charged for since a panic will always revert any prior changes to the storage, including payment taken.</p>
<p>Such an attack will only affect the node receiving an extrinsic directly. The node will compute an extrinsic up until the point of panic. After the panic, it will discard the extrinsic, but still be able to produce a block. The one exception here is a <code>panic</code> in <code>on_initialise</code> or <code>on_finalise</code>, which will actually brick your node since it will be unable to produce a block, as these functions are always called for each block being produced.</p>
<p>You should check in advance for possible error conditions and handle them gracefully. If your state is &quot;irreparably damaged&quot; (i.e. inconsistent), you should still avoid panicking. The best thing to do when you detect such inconsistencies is to simply leave state alone and detect it as early as possible to minimize computation done, and therefore any economic DoS vector.</p>
<p>State inconsistencies can generally be fixed be governance poking state values back into shape. Introducing some sort of &quot;reset&quot;, where possible, for governance to call might also make sense to solve these scenarios.</p>
<h3><a class="anchor" aria-hidden="true" id="no-side-effects-on-error"></a><a href="#no-side-effects-on-error" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>No Side-Effects On Error</h3>
<p>This function must either complete totally (and return <code>Ok(())</code> or it must have no side-effects on storage and return <code>Err('Some reason')</code>.</p>
<p>As a developer building on Substrate, it is critical that you make a distinction about how you should design your runtime logic versus developing a smart contract on a platform like Ethereum.</p>
<p>On Ethereum, if at any point your transaction fails (error, out of gas, etc...), the state of your smart contract will be unaffected. However, on Substrate this is not the case. As soon as a transaction starts to modify the storage of the blockchain, those changes are permanent, even if the transaction would fail at a later time during runtime execution.</p>
<p>This is necessary for blockchain systems since you may want to track things like the nonce of a user or subtract gas fees for any computation that occurred. Both of these things actually happen in the Ethereum state transition function for failed transactions, but you have never had to worry about managing those things as a contract developer.</p>
<p>You will have to be conscious of any changes you make to the state of your blockchain, and ensure that it follows the &quot;verify first, write last&quot; pattern.</p>
<h3><a class="anchor" aria-hidden="true" id="function-return"></a><a href="#function-return" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Function Return</h3>
<p>Dispatchable functions in your module cannot return a value. Instead it can only return a <code>Result</code> which accepts either <code>Ok(())</code> when everything has completed successfully or <code>Err(&amp;'static str)</code> if something goes wrong.</p>
<p>If you do not specify <code>Result</code> explicitly as return value, it will be added automatically for you by the <code>decl_module!</code> macro and <code>Ok(())</code> will be returned at the end.</p>
<p>Thus, this function definition is equivalent to the above example:</p>
<pre><code class="hljs css language-rust"><span class="token macro-rules function">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> Module<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Trait<span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> Call <span class="token keyword">where</span> origin<span class="token punctuation">:</span> T<span class="token punctuation">:</span><span class="token punctuation">:</span>Origin <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">set_value</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> value<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> _sender <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span>?<span class="token punctuation">;</span>
      <span class="token operator">&lt;</span>Value<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>You can still return an <code>Err()</code> at other points in your code like normal.</p>
<h3><a class="anchor" aria-hidden="true" id="proportional-costs-to-computation"></a><a href="#proportional-costs-to-computation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proportional Costs to Computation</h3>
<p>Ensure that calls into each of these execute in a time, memory and using storage space proportional to any costs paid for by the caller or otherwise the difficulty of forcing the call to happen.</p>
<p>If you can't be certain that your module function will succeed without substantial computation then you have a classic blockchain attack scenario. The normal way of managing this is to attach a bond to the operation. As the first major alteration of storage, reserve some value from the sender's account (<code>Balances</code> module has a <code>reserve</code> function for exactly this scenario). This amount should be enough to cover any costs of the substantial execution in case it turns out that you can't proceed with the operation.</p>
<p>If it eventually transpires that the operation is fine and, therefore, that the expense of the checks should be borne by the network, then you can refund the reserved deposit. If, however, the operation turns out to be invalid and the computation is wasted, then you can burn it or repatriate elsewhere.</p>
<h3><a class="anchor" aria-hidden="true" id="check-origin"></a><a href="#check-origin" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Check Origin</h3>
<p>All functions use <code>origin</code> to determine the origin of the call. Modules support checking against one of three <code>origin</code> types:</p>
<ul>
<li>Signed Extrinsic - <code>ensure_signed(origin)?</code></li>
<li>Inherent Extrinsic - <code>ensure_inherent(origin)?</code></li>
<li>Root - <code>ensure_root(origin)?</code></li>
</ul>
<p>You should always match against one of them as the first thing you do in your function, otherwise your chain might be attackable.</p>
<p>You can learn more about <code>Origin</code> [here](TODO: Create Doc)</p>
<h2><a class="anchor" aria-hidden="true" id="reserved-functions"></a><a href="#reserved-functions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reserved Functions</h2>
<p>While you are generally able to name your function anything you want in your module, there are a few functions names which are reserved, and carry with it special functionality that you can access in your module.</p>
<h3><a class="anchor" aria-hidden="true" id="deposit_event"></a><a href="#deposit_event" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>deposit_event()</h3>
<p>If your module wants to emit events, it will need to define a <code>deposit_event()</code> function which handles the events you define in the <code>decl_events</code> macro. Events can contain generics, in which case you should define a <code>deposit_event&lt;T&gt;()</code> function.</p>
<p>The <code>decl_module</code> macro provides a default implementation for the <code>deposit_event()</code> function which you can access by simply defining the function like so:</p>
<pre><code class="hljs css language-rust"><span class="token keyword">fn</span> <span class="token function">deposit_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> default<span class="token punctuation">;</span>

<span class="token comment">// or for events with generics</span>
<span class="token comment">// fn deposit_event&lt;T>() = default;</span>
</code></pre>
<p>If we wanted to emit an event from our <code>decl_module</code> it would look like this:</p>
<pre><code class="hljs css language-rust"><span class="token macro-rules function">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> Module<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Trait<span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> Call <span class="token keyword">where</span> origin<span class="token punctuation">:</span> T<span class="token punctuation">:</span><span class="token punctuation">:</span>Origin <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> deposit_event<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> default<span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function">set_value</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> value<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
      <span class="token keyword">let</span> sender <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span>?<span class="token punctuation">;</span>
      <span class="token operator">&lt;</span>Value<span class="token operator">&lt;</span>T<span class="token operator">>></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">put</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">Self</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">deposit_event</span><span class="token punctuation">(</span>Event<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Set</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We have omitted the <code>decl_event</code> macro definition required for this module to work. You can learn more about events and the <code>decl_event!</code> macro [here] (Coming Soon)</p>
<h3><a class="anchor" aria-hidden="true" id="on_initialise-and-on_finalise"></a><a href="#on_initialise-and-on_finalise" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>on_initialise() and on_finalise()</h3>
<p><code>on_initialise()</code> and <code>on_finalise()</code> are a special functions that gets executed once per block.</p>
<p>These functions can either be called with no parameters, or accept one parameter which has the block number.</p>
<pre><code class="hljs css language-rust"><span class="token comment">// The signature could also be: `fn on_initialise(n: T::BlockNumber)`</span>
<span class="token keyword">fn</span> <span class="token function">on_initialise</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Anything that needs to be done at the beginning of the block.</span>
    <span class="token keyword">Self</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">my_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// The signature could also be: `fn on_finalise()`</span>
<span class="token keyword">fn</span> <span class="token function">on_finalise</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> T<span class="token punctuation">:</span><span class="token punctuation">:</span>BlockNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Anything that needs to be done at the end of the block.</span>
    <span class="token keyword">Self</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">my_function_with_blocknumber</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>You might use <code>on_initalise()</code> to help you with tasks that need to run before any logic in your runtime executes. For example, doing a one-off migration of storage elements for an updated storage schema. You might use <code>on_finalise()</code> to help you clean up any unneeded storage items or to reset values for the next block.</p>
<blockquote>
<p>Note: If you print to console using these functions, you will the output appear twice since it will be called once when the block is prepared and once more when it is imported. However, from within the blockchain, these functions only get called one time.</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="privileged-functions"></a><a href="#privileged-functions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Privileged Functions</h2>
<p>A privileged function is one that can only be called when the origin of the call is <code>Root</code>. An example of a privileged function can be found in the <a href="https://github.com/paritytech/substrate/blob/master/srml/consensus/src/lib.rs"><code>Consensus</code> module</a> for a runtime upgrade:</p>
<pre><code class="hljs css language-rust"><span class="token comment">/// Set the new code.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_code</span><span class="token punctuation">(</span>new<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    storage<span class="token punctuation">:</span><span class="token punctuation">:</span>unhashed<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">put_raw</span><span class="token punctuation">(</span>well_known_keys<span class="token punctuation">:</span><span class="token punctuation">:</span>CODE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Note that this function omits the <code>origin</code> parameter at the beginning of the function inputs. The <code>decl_module!</code> macro automatically converts functions without <code>origin</code> to check that <code>origin</code> is <code>Root</code>. Thus, the function above is equivalent to writing:</p>
<pre><code class="hljs css language-rust"><span class="token comment">/// Set the new code.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">set_code</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> new<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u8<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Result <span class="token punctuation">{</span>
    <span class="token function">ensure_root</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span>?<span class="token punctuation">;</span>
    storage<span class="token punctuation">:</span><span class="token punctuation">:</span>unhashed<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">put_raw</span><span class="token punctuation">(</span>well_known_keys<span class="token punctuation">:</span><span class="token punctuation">:</span>CODE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Where <code>Result</code> and <code>Ok(())</code> were automatically added as mentioned in <a href="#function-return">Function Return</a></p>
<p>Different runtimes have different reasons for allow privileged calls to be executed. Because it's privileged, we can assume it's a one-off operation and substantial processing/storage/memory can be used without worrying about gameability or attack scenarios.</p>
<p>Normally, functions like this would be called via the <code>sudo()</code> function in the <a href="https://github.com/paritytech/substrate/blob/master/srml/sudo/src/lib.rs"><code>Sudo</code> module</a> which can construct a <code>Root</code> call based on a proposal coming from a user.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#declaration-of-the-module-type">Declaration of the Module Type</a></li><li><a href="#functional-requirements">Functional Requirements</a><ul class="toc-headings"><li><a href="#must-not-panic">Must Not Panic</a></li><li><a href="#no-side-effects-on-error">No Side-Effects On Error</a></li><li><a href="#function-return">Function Return</a></li><li><a href="#proportional-costs-to-computation">Proportional Costs to Computation</a></li><li><a href="#check-origin">Check Origin</a></li></ul></li><li><a href="#reserved-functions">Reserved Functions</a><ul class="toc-headings"><li><a href="#deposit_event">deposit_event()</a></li><li><a href="#on_initialise-and-on_finalise">on_initialise() and on_finalise()</a></li></ul></li><li><a href="#privileged-functions">Privileged Functions</a></li></ul></nav></div><footer class="nav-footer" id="footer"><div><style>
#blast {
  display: block;
  position: fixed;
  width: 100%;
  top: 0;
  height: 50px;
  background: #ff1864 url(/img/hacktoberfest-blast-bg.png); background-size: cover;;
  color: white;
  z-index: 99999;
}

#blast h2 {
  margin: 0;
  line-height: 45px;
  text-align: center;
}

#blast a {
  color: white;
  text-decoration: underline;
}

body {
  // let's give it a minimal animation
  transition: ease 1.5s;
  margin-top: 50px;
}
@media only screen and (min-width: 1024px) {
  .docsNavContainer {
    height: calc(100vh - 100px);
    top: 100px;
  }

  .onPageNav {
    max-height: calc(100vh - 140px);
    top: 140px;
  }
}
</style><section id="blast"><h2>Hacktoberfest is here! <a href="https://substrate.dev/hacktoberfest">Hack with us</a></h2></section></div><section class="sitemap"><a href="/" class="nav-home"><img src="/img/Substrate-logo.svg" alt="Substrate Developer Hub" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/zh-CN/getting-started">Getting Started</a><a href="/zh-CN/tutorials">Tutorials</a><a href="/rustdocs/v1.0/">Reference Docs</a><a href="/recipes/">Recipes</a></div><div><h5>Community</h5><a href="/zh-CN/videos">Videos</a><a href="http://stackoverflow.com/questions/tagged/substrate" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://riot.im/app/#/room/!HzySYSaIhtyWrwiwEV:matrix.org">Riot Chat</a><a href="https://twitter.com/ParityTech" target="_blank" rel="noreferrer noopener">Twitter</a><a href="https://www.meetup.com/parity/" target="_blank" rel="noreferrer noopener">Events</a></div><div><h5>More</h5><a href="https://www.parity.io/blog/">Blog</a><a href="https://github.com/paritytech/substrate">Substrate GitHub</a><a href="https://github.com/substrate-developer-hub/">Developer Hub GitHub</a><a href="https://www.parity.io/privacy/">Privacy Policy</a><a href="#" id="cookie-settings">Cookie Settings<script>
              var cookieSettings = document.getElementById('cookie-settings');
              cookieSettings.onclick = function() {
                return klaro.show();
              };
              </script></a></div></section><section class="copyright">Copyright © 2019 Parity Technologies</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '5cd09916f4ba4c283b2d45ee7386fc34',
                indexName: 'substrate',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["language:zh-CN"]}
              });
            </script></body></html>