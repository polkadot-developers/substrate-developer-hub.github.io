<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>添加一个模块 · Substrate Developer Hub</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="[Substrate Node Template](https://github.com/substrate-developer-hub/substrate-node-template) 提供了一个最小可运行的 runtime，让你可快速打造自定义的区块链。 不过，为了让它保持细小，有许多 [FRAME](../../knowledgebase/runtime/frame) 里的模块都没有被包含在内。"/><meta name="docsearch:language" content="zh-CN"/><meta property="og:title" content="添加一个模块 · Substrate Developer Hub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://substrate-developer-hub.github.io//"/><meta property="og:description" content="[Substrate Node Template](https://github.com/substrate-developer-hub/substrate-node-template) 提供了一个最小可运行的 runtime，让你可快速打造自定义的区块链。 不过，为了让它保持细小，有许多 [FRAME](../../knowledgebase/runtime/frame) 里的模块都没有被包含在内。"/><meta property="og:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/load.js"></script><script type="text/javascript" src="/js/redirect-next.js"></script><script type="text/javascript" src="/js/config.js" defer=""></script><script type="text/javascript" src="/js/klaro.min.js" defer=""></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/zh-CN"><img class="logo" src="/img/Substrate-logo.svg" alt="Substrate Developer Hub"/><h2 class="headerTitleWithLogo">Substrate Developer Hub</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/zh-CN/tutorials" target="_self">教程</a></li><li class=""><a href="/docs/zh-CN/" target="_self">知识库</a></li><li class=""><a href="https://substrate.dev/recipes/" target="_self">进阶菜谱</a></li><li class=""><a href="https://substrate.dev/rustdocs/" target="_self">API 文档</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg" alt="Languages icon"/>简体中文</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/en/tutorials/add-contracts-pallet">English</a></li><li><a href="https://crowdin.com/project/substrate-developer-hub" target="_blank" rel="noreferrer noopener">协助翻译</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://crowdin.com/project/substrate-developer-hub/zh-CN" target="_blank" rel="noreferrer noopener">Translate</a><h1 id="__docusaurus" class="postHeaderTitle">添加一个模块</h1></header><article><div><span><p><a href="https://github.com/substrate-developer-hub/substrate-node-template">Substrate Node Template</a> 提供了一个最小可运行的 runtime，让你可快速打造自定义的区块链。 不过，为了让它保持细小，有许多 <a href="../../knowledgebase/runtime/frame">FRAME</a> 里的模块都没有被包含在内。</p>
<p>本指南将向您展示如何可以将 <a href="https://substrate.dev/rustdocs/v2.0.0/pallet_contracts/">Contracts 模块</a> 添加到您的 runtime，以便允许您的区块链支持 Wasm 智能合同。 你可按照类似的方式将其他 FRAME 模块添加到 runtime 里。但需要注意，每个模块在具体配置设定上都会略有差异。</p>
<h2><a class="anchor" aria-hidden="true" id="安装-node-template"></a><a href="#安装-node-template" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>安装 Node Template</h2>
<p>当你完成 <a href=".../.../tutorials/create-your-first-substrate-chain/">创建你第一条 Substrate 链教程</a> 时，你的计算机上应该已编译了 <code>v2.0.0</code> 版本的 <a href="https://github.com/substrate-developer-hub/substrate-node-template">Substrate Node Template</a>。 如果您尚未完成，请完成该教程。</p>
<blockquote>
<p>有经验的开发者可以跳过该教程，您可以参考readme里的步骤说明来安装 。 。</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="文件结构"></a><a href="#文件结构" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>文件结构</h2>
<p>我们现在可以修改 <code>substrate-node-template</code> 来添加 Contracts 模块。</p>
<p>在您喜欢的编辑器中打开 <code>substrate-node-template</code>。 我们将编辑两个文件：<code>runtime/src/lib.rs</code>，和 <code>runtime/Cargo.toml</code>。</p>
<pre><code class="hljs">substrate<span class="token operator">-</span>node<span class="token operator">-</span>template
<span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> runtime
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token class-name">Cargo</span><span class="token punctuation">.</span>toml   <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token class-name">One</span> change <span class="token keyword">in</span> this file
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> build<span class="token punctuation">.</span>rs
<span class="token operator">|</span>   <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> src
<span class="token operator">|</span>      <span class="token operator">|</span>
<span class="token operator">|</span>      <span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> lib<span class="token punctuation">.</span>rs   <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token class-name">Most</span> changes <span class="token keyword">in</span> this file
<span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> pallets
<span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> scripts
<span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> node            <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> changes <span class="token keyword">in</span> this directory
<span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token punctuation">...</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="导入模块-crate"></a><a href="#导入模块-crate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导入模块 Crate</h2>
<p>要添加合约模块，首先应把 <code>pallet-contracts</code> 导入到 runtime 的 <code>Cargo.toml</code> 文件中。 如果您需要 Cargo 相关参考资料的入门导读，可查询 <a href="https://doc.rust-lang.org/cargo/reference/index.html">它的官方文档</a>。</p>
<p>打开 <code>substrate-node-template/runtime/Cargo.toml</code> 文件，您将看到 runtime 的所有依赖组件。 例如，它取决于 <a href="https://substrate.dev/rustdocs/v2.0.0/pallet_balances/">Balances 模块</a>：</p>
<p><strong><code>runtime/Cargo.toml</code></strong></p>
<pre><code class="hljs css language-TOML"><span class="hljs-section">[dependencies]</span>
<span class="hljs-comment">#--snip--</span>
<span class="hljs-attr">pallet-balances</span> = { default-features = <span class="hljs-literal">false</span>, version = <span class="hljs-string">'2.0.0'</span> }
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="crate-特性"></a><a href="#crate-特性" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Crate 特性</h3>
<p>导入pallet crates时需要注意的一件事是确保正确设置crate里的 <code>features</code>内容。 在上面的代码中，你会注意到我们设置了<code>default_features = false</code>。 如果您更仔细地浏览<code>Cargo.toml</code> 文件，则会发现类似以下内容：</p>
<p><strong><code>runtime/Cargo.toml</code></strong></p>
<pre><code class="hljs css language-TOML"><span class="hljs-section">[features]</span>
<span class="hljs-attr">default</span> = [<span class="hljs-string">'std'</span>]
<span class="hljs-attr">std</span> = [
    <span class="hljs-string">'codec/std'</span>,
    <span class="hljs-string">'frame-executive/std'</span>,
    <span class="hljs-string">'frame-support/std'</span>,
    <span class="hljs-string">'frame-system/std'</span>,
    <span class="hljs-string">'frame-system-rpc-runtime-api/std'</span>,
    <span class="hljs-string">'pallet-balances/std'</span>,
    <span class="hljs-comment">#--snip--</span>
]
</code></pre>
<p>第二行代码将runtime crate的 <code>default</code> 特性定义为 <code>std</code>。 您可以想象，每个pallet crate都有一个相似的配置定义该crate的默认特性。 每个 crate 的特性则决定了其下游依赖项的特性。 例如，上面代码应解读为：</p>
<blockquote>
<p>此 Substrate runtime 的默认特性为 <code>std</code>。 当runtime启用 <code>std</code> 特性时, <code>parity-scale-codec</code>, <code>primitives</code>, <code>client</code>和所有其他列出的依赖项也将设置为 <code>std</code>。</p>
</blockquote>
<p>这样使 Substrate runtime 既能编译成原生文件 (支持 Rust：<a href="https://doc.rust-lang.org/std/"><code>std</code></a>) 和 Wasm (不支持： <a href="https://rust-embedded.github.io/book/intro/no-std.html"><code>no_std</code></a>)。</p>
<p>要查看这些功能如何在运行时代码中实际使用，我们可以打开项目文件：</p>
<p><strong><code>runtime/src/lib.rs</code></strong></p>
<pre><code class="hljs css language-rust"><span class="token comment">//! The Substrate Node Template runtime. This can be compiled with `#[no_std]`, ready for Wasm.</span>

<span class="token attribute attr-name">#![cfg_attr(not(feature = <span class="token string">"std"</span>), no_std)]</span>
<span class="token comment">// `construct_runtime!` does a lot of recursion and requires us to increase the limit to 256.</span>
<span class="token attribute attr-name">#![recursion_limit=<span class="token string">"256"</span>]</span>

<span class="token comment">// Make the WASM binary available.</span>
<span class="token attribute attr-name">#[cfg(feature = <span class="token string">"std"</span>)]</span>
<span class="token macro property">include!</span><span class="token punctuation">(</span><span class="token macro property">concat!</span><span class="token punctuation">(</span><span class="token macro property">env!</span><span class="token punctuation">(</span><span class="token string">"OUT_DIR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"/wasm_binary.rs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>
</code></pre>
<p>文件头部定义了当我们 <em>不</em> 使用 <code>std</code> 特性的时候，<code>no_std</code> 特性将会被启用。 再往下走几行代码，可以看见在 <code>wasm_binary.rs</code> 导入代码行上面的 <code>#[cfg(feature = &quot;std&quot;)]</code> 标志，它表示仅在启用了 <code>std</code> 特性后我们才能导入 WASM 二进制文件。</p>
<h3><a class="anchor" aria-hidden="true" id="导入合约模块"></a><a href="#导入合约模块" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>导入合约模块</h3>
<p>既然我们已经对模块的特性有基本认识了，现在就可以开始动手导入合约模块啦。 合约模块可能是 FRAME 中最复杂的模块，所以它是一个很好的例子来说明在添加额外的模块时可能涉及的一些棘手问题。</p>
<p>首先，我们将通过简单地复制现有模块并更改里面的值来添加新的依赖关系。 因此，根据上面 <code>balances</code> 导入样式， <code>contracts</code>导入将看起来像:</p>
<p><strong><code>runtime/Cargo.toml</code></strong></p>
<pre><code class="hljs css language-TOML"><span class="hljs-section">[dependencies]</span>
<span class="hljs-comment">#--snip--</span>
<span class="hljs-attr">pallet-contracts</span> = { version = <span class="hljs-string">'2.0.0'</span>, default_features = <span class="hljs-literal">false</span> }
<span class="hljs-attr">pallet-contracts-primitives</span> = { version = <span class="hljs-string">'2.0.0'</span>, default_features = <span class="hljs-literal">false</span> }
</code></pre>
<p>与其他钱包一样，Contracts 模块也具有 <code>std</code> 的特性。 当 runtime 是使用其自身的 <code>std</code> 特性构建时，Nicks pallet 也应该使用它的 <code>std</code> 功能来构建。 请将以下代码添加到 runtime 的 <code>std</code> 功能。</p>
<p><strong><code>runtime/Cargo.toml</code></strong></p>
<pre><code class="hljs css language-TOML"><span class="hljs-section">[features]</span>
<span class="hljs-attr">default</span> = [<span class="hljs-string">'std'</span>]
<span class="hljs-attr">std</span> = [
    <span class="hljs-comment">#--snip--</span>
    <span class="hljs-string">'pallet-contracts/std'</span>,
    <span class="hljs-string">'pallet-contracts-primitives/std'</span>,
    <span class="hljs-comment">#--snip--</span>
]
</code></pre>
<p>现在正是时候来检查到目前为止所有的改动是否能正确编译：</p>
<pre><code class="hljs css language-bash">SKIP_WASM_BUILD=1 cargo check
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="添加合约模块"></a><a href="#添加合约模块" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>添加合约模块</h2>
<p>现在，我们已成功导入 Contracts 模块，我们现在需要把它添加到我们的 Runtime 中。</p>
<h3><a class="anchor" aria-hidden="true" id="实现-contract-trait"></a><a href="#实现-contract-trait" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>实现 Contract Trait</h3>
<p>每个模块都有称为 <code>Trait</code> 的 runtime 须实现的配置。</p>
<p>要了解我们现在需要为这模块实现什么，你可以查看 <a href="https://substrate.dev/rustdocs/v2.0.0/pallet_contracts/trait.Trait.html"><code>pallet_contracts::Trait</code> 文档</a>。 对于我们的 runtime，实现代码大概看起来这样：</p>
<p><strong><code>runtime/src/lib.rs</code></strong></p>
<pre><code class="hljs css language-rust">
<span class="token comment">// These time units are defined in number of blocks.</span>
   <span class="token comment">/* --snip-- */</span>

<span class="token comment">/*** Add This Block ***/</span>
<span class="token comment">// Contracts price units.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">MILLICENTS</span><span class="token punctuation">:</span> <span class="token class-name">Balance</span> <span class="token operator">=</span> <span class="token number">1_000_000_000</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">CENTS</span><span class="token punctuation">:</span> <span class="token class-name">Balance</span> <span class="token operator">=</span> <span class="token number">1_000</span> <span class="token operator">*</span> <span class="token constant">MILLICENTS</span><span class="token punctuation">;</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">DOLLARS</span><span class="token punctuation">:</span> <span class="token class-name">Balance</span> <span class="token operator">=</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token constant">CENTS</span><span class="token punctuation">;</span>
<span class="token comment">/*** End Added Block ***/</span>
</code></pre>
<pre><code class="hljs css language-rust">
<span class="token keyword">impl</span> <span class="token namespace">pallet_timestamp<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token keyword">for</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
    <span class="token comment">/* --snip-- */</span>
<span class="token punctuation">}</span>

<span class="token comment">/*** Add This Block ***/</span>
<span class="token macro property">parameter_types!</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">TombstoneDeposit</span><span class="token punctuation">:</span> <span class="token class-name">Balance</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token constant">MILLICENTS</span><span class="token punctuation">;</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">RentByteFee</span><span class="token punctuation">:</span> <span class="token class-name">Balance</span> <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> <span class="token constant">MILLICENTS</span><span class="token punctuation">;</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">RentDepositOffset</span><span class="token punctuation">:</span> <span class="token class-name">Balance</span> <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token constant">MILLICENTS</span><span class="token punctuation">;</span>
    <span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token class-name">SurchargeReward</span><span class="token punctuation">:</span> <span class="token class-name">Balance</span> <span class="token operator">=</span> <span class="token number">150</span> <span class="token operator">*</span> <span class="token constant">MILLICENTS</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token keyword">for</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">Time</span> <span class="token operator">=</span> <span class="token class-name">Timestamp</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Randomness</span> <span class="token operator">=</span> <span class="token class-name">RandomnessCollectiveFlip</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Currency</span> <span class="token operator">=</span> <span class="token class-name">Balances</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Event</span> <span class="token operator">=</span> <span class="token class-name">Event</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">DetermineContractAddress</span> <span class="token operator">=</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">SimpleAddressDeterminer</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">TrieIdGenerator</span> <span class="token operator">=</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">TrieIdFromParentCounter</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">RentPayment</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">SignedClaimHandicap</span> <span class="token operator">=</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">DefaultSignedClaimHandicap</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">TombstoneDeposit</span> <span class="token operator">=</span> <span class="token class-name">TombstoneDeposit</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">StorageSizeOffset</span> <span class="token operator">=</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">DefaultStorageSizeOffset</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">RentByteFee</span> <span class="token operator">=</span> <span class="token class-name">RentByteFee</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">RentDepositOffset</span> <span class="token operator">=</span> <span class="token class-name">RentDepositOffset</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">SurchargeReward</span> <span class="token operator">=</span> <span class="token class-name">SurchargeReward</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">MaxDepth</span> <span class="token operator">=</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">DefaultMaxDepth</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">MaxValueSize</span> <span class="token operator">=</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">DefaultMaxValueSize</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">WeightPrice</span> <span class="token operator">=</span> <span class="token namespace">pallet_transaction_payment<span class="token punctuation">::</span></span><span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*** End Added Block ***/</span>
</code></pre>
<p>我们将使用 <code>DetermineContractAddress</code> 类型作为一个例子来深入讲解更多细节，你可从 <a href="https://substrate.dev/rustdocs/v2.0.0/pallet_contracts/trait.Trait.html#associatedtype.DetermineContractAddress"><code>DetermineContractAddress</code> 的文档</a> 看到它需要 <code>ContractAddressFor</code> 的 Trait。 Contracts 模块本身已经实现了 <code>pallet_contracts::SimpleAddressDeterminator</code> Trait，因此我们可以使用该实现代码来满足我们的 <code>pallet_contracts::Trait</code> 条件。 到现在，如果你还不太理解或想深入了解，建议可查看 <a href="https://github.com/paritytech/substrate/blob/v2.0.0/frame/contracts/src/lib.rs">Contracts 模块代码</a>。</p>
<h3><a class="anchor" aria-hidden="true" id="将合约模块添加到-construct_runtime-宏"></a><a href="#将合约模块添加到-construct_runtime-宏" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>将合约模块添加到 <code>construct_runtime!</code> 宏</h3>
<p>接下来，我们需要将模块添加到 <code>construct_runtime!</code> 宏里面。 为此我们应先确定这模块对外开放的类型，以便让 runtime 得知这些类型的存在。 所有类型的完整列表可在 <a href="https://substrate.dev/rustdocs/v2.0.0/frame_support/macro.construct_runtime.html"><code>construct_runtime!</code> 宏的文档</a> 中查看到。</p>
<p>如果我们仔细查看 Contracts 模块，我们知道它具有：</p>
<ul>
<li><strong>Storage</strong> 模块：因为它使用了 <code>decl_storage!</code> 宏。</li>
<li><strong>Event</strong>模块：因为它使用了<code>decl_event!</code> 宏。</li>
<li><strong>Call</strong>able 函数：因为它在 <code>decl_module!</code>宏中定义了可调用函数。</li>
<li><strong>可配置</strong> 值：因为 <code>decl_storage!</code> 宏有 <code>config()</code> 参数。</li>
<li>在 <code>decl_module!</code> 宏里定义的 <strong>Module</strong> 类型。</li>
</ul>
<p>因此当我们添加模块时，它看起来就像：</p>
<p><strong><code>runtime/src/lib.rs</code></strong></p>
<pre><code class="hljs css language-rust"><span class="token macro property">construct_runtime!</span><span class="token punctuation">(</span>
    <span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Runtime</span> <span class="token keyword">where</span>
        <span class="token class-name">Block</span> <span class="token operator">=</span> <span class="token class-name">Block</span><span class="token punctuation">,</span>
        <span class="token class-name">NodeBlock</span> <span class="token operator">=</span> <span class="token namespace">opaque<span class="token punctuation">::</span></span><span class="token class-name">Block</span><span class="token punctuation">,</span>
        <span class="token class-name">UncheckedExtrinsic</span> <span class="token operator">=</span> <span class="token class-name">UncheckedExtrinsic</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/* --snip-- */</span>

        <span class="token comment">/*** Add This Line ***/</span>
        <span class="token class-name">Contracts</span><span class="token punctuation">:</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Module</span><span class="token punctuation">,</span> <span class="token class-name">Call</span><span class="token punctuation">,</span> <span class="token class-name">Config</span><span class="token punctuation">,</span> <span class="token class-name">Storage</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>请注意并非所有的模块都会开放出这些 runtime 类型，有些也有可能开放更多！ 您总是可以查看模块的源代码或模块的文档来确定您需要开放出的数据类型。</p>
<p>现在也正好是时间来检查您的 runtime 到目前为止是否能够正确编译。 虽然 runtime 可以编译，但整个节点不会通过。 所以我们将使用此命令来检查 runtime。</p>
<pre><code class="hljs css language-bash">SKIP_WASM_BUILD=1 cargo check -p node-template-runtime
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="开放出-contracts-api"></a><a href="#开放出-contracts-api" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开放出 Contracts API</h3>
<p>一些模块 (包括 Contracts 模块)，会开放自定义的 runtime APIs 和 RPC 端点。 在 Contracts 模块这例子，它允许从链外读取合约状态。</p>
<p>但注意要使用这个模块，也不是一定要开放 RPC 端点。 然而我们这样做，可在没有发起交易的情况下也可以调用节点存储。</p>
<p>首先我们在 <code>Cargo.toml</code> 中添加所需的 API 依赖关系。</p>
<p><strong><code>runtime/Cargo.toml</code></strong></p>
<pre><code class="hljs css language-TOML"><span class="hljs-section">[dependencies]</span>
<span class="hljs-comment">#--snip--</span>
<span class="hljs-attr">pallet-contracts-rpc-runtime-api</span> = { version = <span class="hljs-string">'0.8.0'</span>, default-features = <span class="hljs-literal">false</span> }
</code></pre>
<p><strong><code>runtime/Cargo.toml</code></strong></p>
<pre><code class="hljs css language-TOML"><span class="hljs-section">[features]</span>
<span class="hljs-attr">default</span> = [<span class="hljs-string">'std'</span>]
<span class="hljs-attr">std</span> = [
    <span class="hljs-comment">#--snip--</span>
    <span class="hljs-string">'pallet-contracts-rpc-runtime-api/std'</span>,
]
</code></pre>
<p>为获取合约变量状态，我们须要调用获取函数 (getter function) 返回 <code>ContractExecResult</code> ，它是对当前执行状态的封装。</p>
<p>我们需要将返回类型添加到 runtime 里。 我们用 <code>use</code> 语句来添加，如下：</p>
<p><strong><code>runtime/src/lib.rs</code></strong></p>
<pre><code class="hljs css language-rust"><span class="token comment">/*** Add This Line ***/</span>
<span class="token keyword">use</span> <span class="token namespace">pallet_contracts_rpc_runtime_api<span class="token punctuation">::</span></span><span class="token class-name">ContractExecResult</span><span class="token punctuation">;</span>
<span class="token comment">/* --snip-- */</span>
</code></pre>
<p>现在我们可实现 Contracts 在 runtime 里的 API。 这是在 runtime 末尾 <code>impl_runtime_apis!</code> 宏里面发生的。</p>
<pre><code class="hljs css language-rust"><span class="token macro property">impl_runtime_apis!</span> <span class="token punctuation">{</span>
   <span class="token comment">/* --snip-- */</span>

   <span class="token comment">/*** Add This Block ***/</span>
    <span class="token keyword">impl</span> <span class="token namespace">pallet_contracts_rpc_runtime_api<span class="token punctuation">::</span></span><span class="token class-name">ContractsApi</span><span class="token operator">&lt;</span><span class="token class-name">Block</span><span class="token punctuation">,</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span> <span class="token class-name">Balance</span><span class="token punctuation">,</span> <span class="token class-name">BlockNumber</span><span class="token operator">></span>
        <span class="token keyword">for</span> <span class="token class-name">Runtime</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">fn</span> <span class="token function-definition function">call</span><span class="token punctuation">(</span>
            origin<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span>
            dest<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> <span class="token class-name">Balance</span><span class="token punctuation">,</span>
            gas_limit<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
            input_data<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">ContractExecResult</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token punctuation">(</span>exec_result<span class="token punctuation">,</span> gas_consumed<span class="token punctuation">)</span> <span class="token operator">=</span>
                <span class="token class-name">Contracts</span><span class="token punctuation">::</span><span class="token function">bare_call</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> dest<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> gas_limit<span class="token punctuation">,</span> input_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">match</span> exec_result <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">ContractExecResult</span><span class="token punctuation">::</span><span class="token class-name">Success</span> <span class="token punctuation">{</span>
                    flags<span class="token punctuation">:</span> v<span class="token punctuation">.</span>flags<span class="token punctuation">.</span><span class="token function">bits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    data<span class="token punctuation">:</span> v<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
                    gas_consumed<span class="token punctuation">:</span> gas_consumed<span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">ContractExecResult</span><span class="token punctuation">::</span><span class="token class-name">Error</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">fn</span> <span class="token function-definition function">get_storage</span><span class="token punctuation">(</span>
            address<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span>
            key<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">;</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">pallet_contracts_primitives<span class="token punctuation">::</span></span><span class="token class-name">GetStorageResult</span> <span class="token punctuation">{</span>
            <span class="token class-name">Contracts</span><span class="token punctuation">::</span><span class="token function">get_storage</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">fn</span> <span class="token function-definition function">rent_projection</span><span class="token punctuation">(</span>
            address<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">pallet_contracts_primitives<span class="token punctuation">::</span></span><span class="token class-name">RentProjectionResult</span><span class="token operator">&lt;</span><span class="token class-name">BlockNumber</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token class-name">Contracts</span><span class="token punctuation">::</span><span class="token function">rent_projection</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
   <span class="token comment">/*** End Added Block ***/</span>
<span class="token punctuation">}</span>
</code></pre>
<p>现在又是一个好时候检查您的 runtime 是否可正确编译。</p>
<pre><code class="hljs css language-bash">SKIP_WASM_BUILD=1 cargo check -p node-template-runtime
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="更新外部节点"></a><a href="#更新外部节点" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>更新外部节点</h2>
<p>此时，我们已经完成添加一个模块到 runtime 里。 我们现在将注意力转向外部节点，这些节点常常需要一些相应的更新。 对于 Contracts 模块，我们将添加自定义 RPC 端点和创世配置 (genesis configuration)。</p>
<h3><a class="anchor" aria-hidden="true" id="添加-rpc-api-扩展"></a><a href="#添加-rpc-api-扩展" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>添加 RPC API 扩展</h3>
<p>開放了 runtime API 后，我们现在可以将 RPC 添加到节点服务中来调用 runtime API。 因为我们现在是在外部节点寫代碼，我们不需要以 <code>no_std</code> feature 來构建，也不需要维持专用的 <code>std</code> feature。</p>
<p><strong><code>node/Cargo.toml</code></strong></p>
<pre><code class="hljs css language-toml"><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">jsonrpc-core</span> <span class="token punctuation">=</span> <span class="token string">'15.0.0'</span>
<span class="token key property">structopt</span> <span class="token punctuation">=</span> <span class="token string">'0.3.8'</span>
<span class="token comment">#--snip--</span>
<span class="token comment"># *** Add this 2 lines ***</span>
<span class="token key property">pallet-contracts</span> <span class="token punctuation">=</span> <span class="token string">'2.0.0'</span>
<span class="token key property">pallet-contracts-rpc</span> <span class="token punctuation">=</span> <span class="token string">'0.8.0'</span>
</code></pre>
<p>Substrate 提供一个 RPC 与我们的节点交互。 然而，默认它不具备访问Contracts 模块的权限。 要与这个模块进行交互，我们必须扩展现有的 RPC 和添加 Contracts 模块的 API 实现。</p>
<p><strong><code>node/src/rpc.rs</code></strong></p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> <span class="token namespace">node_template_runtime<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">opaque<span class="token punctuation">::</span></span><span class="token class-name">Block</span><span class="token punctuation">,</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span> <span class="token class-name">Balance</span><span class="token punctuation">,</span> <span class="token class-name">Index</span><span class="token punctuation">,</span> <span class="token class-name">BlockNumber</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">pallet_contracts_rpc<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">Contracts</span><span class="token punctuation">,</span> <span class="token class-name">ContractsApi</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre><code class="hljs css language-rust"><span class="token comment">/// Instantiate all full RPC extensions.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_full</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">(</span>
    deps<span class="token punctuation">:</span> <span class="token class-name">FullDeps</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">P</span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">jsonrpc_core<span class="token punctuation">::</span></span><span class="token class-name">IoHandler</span><span class="token operator">&lt;</span><span class="token namespace">sc_rpc<span class="token punctuation">::</span></span><span class="token class-name">Metadata</span><span class="token operator">></span> <span class="token keyword">where</span>
    <span class="token comment">/* --snip-- */</span>
    <span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token punctuation">,</span>
    <span class="token class-name">C</span><span class="token punctuation">::</span><span class="token class-name">Api</span><span class="token punctuation">:</span> <span class="token namespace">substrate_frame_rpc_system<span class="token punctuation">::</span></span><span class="token class-name">AccountNonceApi</span><span class="token operator">&lt;</span><span class="token class-name">Block</span><span class="token punctuation">,</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span> <span class="token class-name">Index</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/*** Add This Line ***/</span>
    <span class="token class-name">C</span><span class="token punctuation">::</span><span class="token class-name">Api</span><span class="token punctuation">:</span> <span class="token namespace">pallet_contracts_rpc<span class="token punctuation">::</span></span><span class="token class-name">ContractsRuntimeApi</span><span class="token operator">&lt;</span><span class="token class-name">Block</span><span class="token punctuation">,</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span> <span class="token class-name">Balance</span><span class="token punctuation">,</span> <span class="token class-name">BlockNumber</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token comment">/* --snip-- */</span>
<span class="token punctuation">{</span>
    <span class="token comment">/* --snip-- */</span>

    <span class="token comment">// Extend this RPC with a custom API by using the following syntax.</span>
    <span class="token comment">// `YourRpcStruct` should have a reference to a client, which is needed</span>
    <span class="token comment">// to call into the runtime.</span>
    <span class="token comment">// `io.extend_with(YourRpcTrait::to_delegate(YourRpcStruct::new(ReferenceToClient, ...)));`</span>

    <span class="token comment">/*** Add This Block ***/</span>
    io<span class="token punctuation">.</span><span class="token function">extend_with</span><span class="token punctuation">(</span>
        <span class="token class-name">ContractsApi</span><span class="token punctuation">::</span><span class="token function">to_delegate</span><span class="token punctuation">(</span><span class="token class-name">Contracts</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*** End Added Block ***/</span>
    io
<span class="token punctuation">}</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="创世配置"></a><a href="#创世配置" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>创世配置</h3>
<p>并非所有模块都有创世配置，但如果有，你可透过阅读文档来学习它。 例如 <a href="https://substrate.dev/rustdocs/v2.0.0/pallet_contracts/struct.GenesisConfig.html"><code>pallet_contracts::GenesisConfig</code> 的文档</a> 描述了所有需要为 Contracts 模块定义的字段。</p>
<p>创世配置是在 <code>node/src/chain_spec.rs</code> 中设置的。 我们修改此文件，包括 <code>ContractsConfig</code> 类型和把合约价格单位放在文件顶端：</p>
<p><strong><code>node/src/chain_spec.rs</code></strong></p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> <span class="token namespace">node_template_runtime<span class="token punctuation">::</span></span><span class="token class-name">ContractsConfig</span><span class="token punctuation">;</span>
</code></pre>
<p>然后在 <code>testnet_genesis</code> 函数中，我们需要将合约配置添加到返回的 <code>GenesisConfig</code> 对象中，示例如下：</p>
<blockquote>
<p>重要：我们正在从函数参数中获取 <code>_enable_println</code> 的值。 确保移除参数名称前面的下划线。</p>
</blockquote>
<pre><code class="hljs css language-rust"><span class="token comment">/// Configure initial storage state for FRAME modules.</span>
<span class="token keyword">fn</span> <span class="token function-definition function">testnet_genesis</span><span class="token punctuation">(</span>
    wasm_binary<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    initial_authorities<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">AuraId</span><span class="token punctuation">,</span> <span class="token class-name">GrandpaId</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token punctuation">,</span>
    root_key<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span>
    endowed_accounts<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">AccountId</span><span class="token operator">></span><span class="token punctuation">,</span>
    enable_println<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span> <span class="token comment">// Update this line</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">GenesisConfig</span> <span class="token punctuation">{</span>
    <span class="token class-name">GenesisConfig</span> <span class="token punctuation">{</span>
        <span class="token comment">/* --snip-- */</span>

        <span class="token comment">/*** Add This Block ***/</span>
        pallet_contracts<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">ContractsConfig</span> <span class="token punctuation">{</span>
            current_schedule<span class="token punctuation">:</span> <span class="token namespace">pallet_contracts<span class="token punctuation">::</span></span><span class="token class-name">Schedule</span> <span class="token punctuation">{</span>
                    enable_println<span class="token punctuation">,</span>
                    <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">/*** End Added Block ***/</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="启动您升级过的链"></a><a href="#启动您升级过的链" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>启动您升级过的链</h2>
<p>现在您已经准备好编译和运行能处理合约的节点。 用以下命令以发布 (release) 模式编译节点：</p>
<pre><code class="hljs css language-bash">WASM_BUILD_TOOLCHAIN=nightly-2020-10-05 cargo build --release
</code></pre>
<p>现在通过运行此命令来启动您刚刚建立的可执行程序</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># 在开发模式运行一个临时节点</span>
./target/release/node-template --dev --tmp
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="添加其它-frame-pallets"></a><a href="#添加其它-frame-pallets" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>添加其它 FRAME Pallets</h2>
<p>在本教程中，我们专门介绍了如何导入合约模块，但是正如开头所提到的，每个模块的导入方法都会有些许不同。 请不要担心，您总是可以参考 <a href="https://github.com/paritytech/substrate/blob/v2.0.0/bin/node/runtime/">演示 Substrate node runtime </a>，该 runtime 几乎包含了核心库中的所有模块。</p>
<p>在 Substrate runtime 的 <code>Cargo.toml</code> 文件中，您将看到如何导入不同的模块，在 <code>lib.rs</code> 文件中，您会看到如何把每个模块添加到您的 runtime 里去。 您基本上可以将在那里完成的操作复制到您自己的 runtime。</p>
<h3><a class="anchor" aria-hidden="true" id="进一步学习"></a><a href="#进一步学习" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进一步学习</h3>
<ul>
<li><a href="../../tutorials/create-a-pallet/">最简指南：在您自己的 package 中编写 runtime</a>。</li>
<li>您的节点现在能够运行智能合约，学习 <a href="../../knowledgebase/smart-contracts/">Substrate ink！ 智能合约</a>。</li>
<li><a href="https://substrate.dev/recipes/">Substrate Recipes</a> 提供详细教程，如何写 <a href="https://substrate.dev/recipes/3-entrees/runtime-api.html">Runtime API</a> 和 <a href="https://substrate.dev/recipes/3-entrees/custom-rpc.html">自定义 RPC</a> ，类以于本教程中提到那些。</li>
<li>了解 <a href="../../knowledgebase/integrate/chain-spec">Chain Spec</a> 文件以自定义创世配置。</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="参考文档"></a><a href="#参考文档" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考文档</h3>
<ul>
<li><a href="https://substrate.dev/rustdocs/v2.0.0/pallet_contracts/index.html">FRAME <code>Contract</code> 模块 API</a></li>
</ul>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#安装-node-template">安装 Node Template</a></li><li><a href="#文件结构">文件结构</a></li><li><a href="#导入模块-crate">导入模块 Crate</a><ul class="toc-headings"><li><a href="#crate-特性">Crate 特性</a></li><li><a href="#导入合约模块">导入合约模块</a></li></ul></li><li><a href="#添加合约模块">添加合约模块</a><ul class="toc-headings"><li><a href="#实现-contract-trait">实现 Contract Trait</a></li><li><a href="#将合约模块添加到-construct_runtime-宏">将合约模块添加到 <code>construct_runtime!</code> 宏</a></li><li><a href="#开放出-contracts-api">开放出 Contracts API</a></li></ul></li><li><a href="#更新外部节点">更新外部节点</a><ul class="toc-headings"><li><a href="#添加-rpc-api-扩展">添加 RPC API 扩展</a></li><li><a href="#创世配置">创世配置</a></li></ul></li><li><a href="#启动您升级过的链">启动您升级过的链</a></li><li><a href="#添加其它-frame-pallets">添加其它 FRAME Pallets</a><ul class="toc-headings"><li><a href="#进一步学习">进一步学习</a></li><li><a href="#参考文档">参考文档</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/Substrate-logo.svg" alt="Substrate Developer Hub" width="66" height="58"/></a><div><h5>开发者中心</h5><a href="/zh-CN/tutorials">教程</a><a href="/docs/zh-CN/">知识库</a><a href="https://substrate.dev/recipes/">进阶菜谱</a><a href="https://substrate.dev/rustdocs">API 文档</a></div><div><h5>社区</h5><a href="/zh-CN/community">社区主页</a><a href="/zh-CN/newsletter">通讯</a><a href="https://app.element.io/#/room/!HzySYSaIhtyWrwiwEV:matrix.org">Substrate 技术聊天室</a><a href="/zh-CN/seminar">Substrate 研讨会</a><a href="http://stackoverflow.com/questions/tagged/substrate" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://twitter.com/ParityTech" target="_blank" rel="noreferrer noopener">推特</a><a href="https://www.meetup.com/parity/" target="_blank" rel="noreferrer noopener">聚会活动</a></div><div><h5>更多</h5><a href="https://www.substrate.io/builders-program/">Substrate Builders 计划</a><a href="https://www.parity.io/blog/">Blog</a><a href="https://github.com/paritytech/substrate">Substrate GitHub</a><a href="https://github.com/substrate-developer-hub/">开发者中心 GitHub</a><a href="https://www.parity.io/privacy/">隐私政策</a><a href="/terms">使用条款</a><a href="#" id="cookie-settings">Cookie 设置<script>
                var cookieSettings = document.getElementById('cookie-settings');
                cookieSettings.onclick = function() {
                  return klaro.show();
                };
              </script></a></div></section><section class="copyright">Copyright © 2021 Parity Technologies</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '5cd09916f4ba4c283b2d45ee7386fc34',
                indexName: 'substrate',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["language:zh-CN"]}
              });
            </script></body></html>